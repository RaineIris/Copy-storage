<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文案与文件存放站</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;</script>
    <style>
        /* --- 全局与主题样式 --- */
        :root {
            /* 核心颜色变量 */
            --theme-hue: 215;
            --theme-sat: 50%;
            --theme-light: 50%;

            /* 派生颜色变量 */
            --primary-bg: hsl(var(--theme-hue), calc(var(--theme-sat) * 0.9), 95%);
            --sidebar-bg: hsl(var(--theme-hue), var(--theme-sat), 92%);
            --main-header-bg: #ffffff;
            --card-bg: #ffffff;
            --button-bg: hsl(var(--theme-hue), var(--theme-sat), var(--theme-light));
            --button-hover-bg: hsl(var(--theme-hue), var(--theme-sat), calc(var(--theme-light) - 7%));
            
            --theme-color-darker: hsl(var(--theme-hue), calc(var(--theme-sat) * 1.1), calc(var(--theme-light) * 0.7));

            --text-color: #333333;
            --subtle-text-color: #777777;
            --border-color: hsl(var(--theme-hue), calc(var(--theme-sat) * 0.7), 86%);
            --shadow-color: hsla(var(--theme-hue), 25%, 50%, 0.1);
            --highlight-bg: #fff176;
            --font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            --line-height: 1.6; /* 定义行高变量 */
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--text-color);
            line-height: var(--line-height);
            overflow-x: hidden;
            transition: background-color 0.3s;
        }
        body.modal-open { overflow: hidden; }

        /* --- 主布局 --- */
        .container { display: flex; height: 100vh; }

        .sidebar {
            width: 220px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            box-sizing: border-box;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 200;
            transform: translateX(-100%);
            transition: transform 0.35s ease-out, background-color 0.3s, border-color 0.3s;
            box-shadow: 2px 0 5px var(--shadow-color);
            user-select: none; /* 防止拖动时选中文本 */
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            flex-shrink: 0;
        }
        .sidebar-header h2 { margin: 0; font-size: 1.5em; color: var(--theme-color-darker); transition: color 0.3s; }
        .sidebar-actions { display: flex; gap: 10px; }
        .sidebar-actions button {
            background: none;
            border: 1px solid var(--theme-color-darker);
            color: var(--theme-color-darker);
            border-radius: 5px;
            padding: 3px 8px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.3s;
        }
        .sidebar-actions button:hover { background-color: var(--theme-color-darker); color: white; }

        #group-list { list-style-type: none; padding: 0; margin-top: 15px; flex-grow: 1; overflow-y: auto; }
        #group-list li {
            padding: 10px 15px;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s, opacity 0.2s, border 0.2s;
            text-align: left;
            overflow: hidden; /* 配合flex-1的ellipsis */
            display: flex; /* 新增: 为了分组计数 */
            justify-content: space-between; /* (F3) 修改: 保持两端对齐 (根据你的反馈) */
            align-items: center; /* 新增: 为了分组计数 */
        }
        /* 配合flex, 让文字溢出省略 */
        #group-list li > span:first-child {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        /* (F3) 修改: 分组计数的样式 */
        .group-count {
            font-size: 0.8em; /* (F3) 修改: 调小字体 */
            color: var(--subtle-text-color);
            font-weight: normal;
            margin-left: 6px; /* (F3) 修改: 调小间距 */
            /* (F3) 移除: background-color, padding, border-radius */
        }
        /* (F3) 修改: 移除 active 时的背景色 */
        #group-list li.active .group-count {
            color: white;
            opacity: 0.7; /* (F3) 修改: 调暗一点 */
        }
        
        #group-list li.draggable { cursor: grab; }
        #group-list li.draggable:active { cursor: grabbing; }
        #group-list li.active { background-color: var(--button-bg); color: white; font-weight: bold; }
        #group-list .divider { height: 1px; background-color: var(--border-color); margin: 8px 0; padding: 0; }
        #group-list .dragging { opacity: 0.4; }
        #group-list .drag-over { border-top: 2px solid var(--button-bg); }


        /* 主题美化模块 */
        .theme-customizer { flex-shrink: 0; padding-top: 15px; margin-top: 15px; border-top: 1px solid var(--border-color); }
        .theme-customizer h3 { font-size: 1em; margin: 0 0 10px 0; color: var(--subtle-text-color); }
        #preset-colors { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .preset-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .preset-dot:hover { transform: scale(1.1); }
        .preset-dot.active { border-color: var(--button-bg); }
        .custom-color-wrapper { display: flex; align-items: center; gap: 10px; }
        .custom-color-wrapper label { font-size: 0.9em; }
        #custom-color-picker { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 28px; height: 28px; background-color: transparent; border: none; cursor: pointer; padding: 0; }
        #custom-color-picker::-webkit-color-swatch { border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        #custom-color-picker::-moz-color-swatch { border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; width: 100%; }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); z-index: 199; opacity: 0; visibility: hidden; transition: opacity 0.35s ease-out, visibility 0.35s ease-out; }
        #sidebar-overlay.visible { opacity: 1; visibility: visible; }

        .main-header { padding: 15px 25px 15px 15px; background-color: var(--main-header-bg); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 4px var(--shadow-color); z-index: 10; display: flex; align-items: center; gap: 12px; }
        #hamburger-menu { font-size: 1.8em; cursor: pointer; color: var(--theme-color-darker); padding: 5px; margin-right: 3px; border-radius: 5px; transition: background-color 0.2s, color 0.3s; }

        /* --- (新) 多关键词搜索框 --- */
        .multi-search-wrapper {
            flex-grow: 1;
            padding: 7px 15px;
            font-size: 1em;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #fff;
            display: flex;
            flex-wrap: nowrap; /* (新) 修改: wrap -> nowrap (强制一行) */
            overflow-x: auto; /* (新) 新增: 允许横向滚动 */
            align-items: center;
            gap: 6px;
            cursor: text;
        }
        .multi-search-wrapper:focus-within {
            outline: none;
            border-color: var(--button-bg);
            box-shadow: 0 0 5px hsla(var(--theme-hue), var(--theme-sat), var(--theme-light), 0.5);
        }

        .keyword-tag {
            display: inline-flex;
            align-items: center;
            background-color: hsl(var(--theme-hue), var(--theme-sat), 90%);
            color: var(--theme-color-darker);
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 0.9em;
            font-weight: 500;
            white-space: nowrap;
        }
        .keyword-tag .remove-tag {
            display: inline-block;
            margin-left: 6px;
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--theme-color-darker);
            font-size: 1.1em;
            line-height: 1;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .keyword-tag .remove-tag:hover {
            opacity: 1;
        }

        #search-input {
            border: none;
            outline: none;
            padding: 0;
            font-size: 1em;
            font-family: var(--font-family);
            background-color: transparent;
            flex-grow: 1;
            min-width: 100px; /* (新) 修改: 200px -> 100px, 保证在有tag时仍有输入空间 */
            line-height: 1.6;
        }
        /* --- 结束 多关键词搜索框 --- */

        /* 搜索筛选按钮 (F3) */
        #search-filter-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--subtle-text-color);
            font-size: 1em;
            padding: 7px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        #search-filter-btn:hover {
            background-color: #f0f0f0;
            border-color: var(--subtle-text-color);
        }
        #search-filter-btn.active {
            border-color: var(--button-bg);
            background-color: var(--primary-bg);
            color: var(--button-bg);
            font-weight: bold;
        }

        /* 搜索筛选弹窗 (F3) */
        #search-filter-modal {
            position: absolute;
            top: 75px; /* 调整到 .main-header 下方 */
            right: 25px;
            width: 250px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px var(--shadow-color);
            z-index: 101;
            display: none;
            padding: 15px;
            box-sizing: border-box;
        }
        #search-filter-modal.visible { display: block; }
        #search-filter-modal h3 { margin: 0 0 10px 0; font-size: 1.1em; color: var(--text-color); }
        #search-filter-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 5px;
            margin-bottom: 10px;
            background: var(--primary-bg);
        }
        #search-filter-list label {
            display: block;
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        #search-filter-list label:hover { background-color: #f0f0f0; }
        #search-filter-list input { margin-right: 8px; }
        .search-filter-actions { display: flex; gap: 10px; }
        .search-filter-actions button {
            flex: 1;
            padding: 6px 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #search-filter-apply {
            background-color: var(--button-bg);
            color: white;
            border-color: var(--button-bg);
        }
        #search-filter-apply:hover { background-color: var(--button-hover-bg); }
        #search-filter-clear { background-color: #f1f1f1; color: var(--subtle-text-color); }
        #search-filter-clear:hover { background-color: #e0e0e0; }


        #items-container { flex-grow: 1; overflow-y: auto; padding: 30px; padding-bottom: 120px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; align-content: start; }

        .note-card, .file-card { background-color: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px var(--shadow-color); display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--border-color); position: relative; }
        .note-card:hover, .file-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px hsla(var(--theme-hue), 20%, 50%, 0.15); }
        .file-card { cursor: pointer; }

        .note-content { white-space: pre-wrap; word-wrap: break-word; flex-grow: 1; margin-bottom: 15px; transition: max-height 0.35s ease-in-out; }
        .note-content.collapsible { max-height: calc(1em * var(--line-height) * 5); overflow: hidden; position: relative; cursor: pointer; }
        .note-content.collapsible:not(.expanded)::after { content: '... 点击展开'; position: absolute; bottom: 0; right: 0; background: linear-gradient(to right, transparent, var(--card-bg) 25%); padding: 0 0 2px 30px; color: var(--subtle-text-color); font-weight: bold; font-size: 0.9em; }
        
        .item-footer { border-top: 1px solid var(--border-color); padding-top: 10px; font-size: 0.9em; color: var(--subtle-text-color); }
        .item-footer .group { background-color: var(--primary-bg); padding: 3px 8px; border-radius: 4px; font-weight: bold; color: var(--theme-color-darker); margin-right: 10px; display: inline-block; transition: background-color 0.3s, color 0.3s; }

        /* (F2) 修改: 卡片底部动作栏 */
        .item-actions {
            margin-top: 10px;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            align-items: center; /* (F2) 修改: 垂直居中对齐 */
            flex-wrap: wrap;
            gap: 0 10px; /* 按钮间距 */
        }
        .item-actions button {
            background: none; border: none; cursor: pointer; padding: 5px; 
            margin-left: 0;
            font-size: 0.9em; color: var(--subtle-text-color); transition: color 0.2s; display: inline-flex; align-items: center; gap: 3px;
        }
        .item-actions button:hover { color: var(--button-bg); }
        .highlight { background-color: var(--highlight-bg); border-radius: 3px; padding: 0 2px; color: #333; }

        /* (F2) 时间戳样式 */
        .item-timestamps {
            font-size: 0.8em;
            color: var(--subtle-text-color);
            line-height: 1.4;
            margin-right: auto; /* 推到最左边 */
            text-align: left;
            /* (F1) 移除: padding-bottom: 5px; (真的移除了) */
        }
        .item-timestamps .timestamp {
            white-space: nowrap;
        }
        /* (新) 移除: .item-timestamps .timestamp.modified 样式 (不再需要) */


        .file-info { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-grow: 1; }
        .file-info .icon { font-size: 2.5em; color: var(--button-bg); }
        .file-details .filename { font-weight: bold; word-break: break-all; }
        .file-details .file-size { font-size: 0.8em; color: var(--subtle-text-color); }

        #add-note-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--button-bg); color: white; border: none; border-radius: 50%; font-size: 2em; line-height: 60px; text-align: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); transition: background-color 0.3s, transform 0.2s; z-index: 100; }
        #add-note-btn:hover { background-color: var(--button-hover-bg); transform: scale(1.1); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal { background-color: var(--primary-bg); padding: 30px 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25); width: 90%; max-width: 500px; transform: scale(0.9); transition: transform 0.3s, background-color 0.3s; }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal h3 { margin-top: 0; margin-bottom: 25px; font-size: 1.8em; color: var(--theme-color-darker); text-align: center; transition: color 0.3s;}
        .modal .form-group { margin-bottom: 20px; }
        .modal label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-color); }
        .modal input[type="text"], .modal textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); background-color: #fff; border-radius: 8px; font-size: 1em; font-family: var(--font-family); box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
        .modal input[type="text"]:focus, .modal textarea:focus { outline: none; border-color: var(--button-bg); box-shadow: 0 0 5px hsla(var(--theme-hue), var(--theme-sat), var(--theme-light), 0.5); }
        .modal textarea { min-height: 150px; resize: vertical; }
        .group-input-wrapper { position: relative; display: flex; align-items: center; }
        .group-input-wrapper input { padding-right: 35px !important; }
        .group-dropdown-toggle { position: absolute; right: 1px; top: 1px; bottom: 1px; width: 35px; border: none; background: transparent; color: var(--subtle-text-color); cursor: pointer; font-size: 0.8em; border-radius: 0 8px 8px 0; }
        .group-dropdown-toggle:hover { background-color: rgba(0,0,0,0.05); }

        .form-divider { text-align: center; border-bottom: 1px solid var(--border-color); line-height: 0.1em; margin: 25px 0; }
        .form-divider span { background: var(--primary-bg); padding: 0 10px; color: var(--subtle-text-color); font-size: 0.9em; transition: background-color 0.3s; }
        #upload-file-btn { width: 100%; padding: 12px; background-color: #f1f1f1; color: var(--subtle-text-color); border: 1px dashed var(--border-color); border-radius: 8px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        #upload-file-btn:hover { background-color: #e9e9e9; border-color: var(--button-bg); }

        .modal-buttons { display: flex; align-items: center; gap: 15px; margin-top: 25px; }
        .modal-buttons button { flex: 1; text-align: center; padding: 10px 15px; border-radius: 8px; border: 1px solid; font-size: 1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s, color 0.2s, transform 0.1s, border-color 0.3s; }
        .modal-buttons button:active { transform: scale(0.98); }

        #save-note-btn, #info-ok-btn, #save-file-btn, #import-select-file-btn, #html-viewer-close-btn { background-color: var(--button-bg); color: white; border-color: var(--button-bg); }
        #save-note-btn:hover, #info-ok-btn:hover, #save-file-btn:hover, #import-select-file-btn:hover, #html-viewer-close-btn:hover { background-color: var(--button-hover-bg); border-color: var(--button-hover-bg); }
        #cancel-btn, #import-options-cancel-btn, #cancel-file-btn { background-color: #f1f1f1; color: var(--subtle-text-color); border-color: var(--border-color); }
        #cancel-btn:hover, #import-options-cancel-btn:hover, #cancel-file-btn:hover { background-color: #e0e0e0; }
        
        #confirm-yes { background-color: #e74c3c; color: white; border-color: transparent; }
        #confirm-yes:hover { background-color: #c0392b; }
        #confirm-no { background-color: #f1f1f1; color: var(--subtle-text-color); border-color: var(--border-color); }
        #confirm-no:hover { background-color: #e0e0e0; }
        
        .group-form-group { position: relative; }
        .group-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: white; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px var(--shadow-color); max-height: 160px; overflow-y: auto; z-index: 1001; }
        .group-dropdown.visible { display: block; }
        .dropdown-item { padding: 10px 12px; cursor: pointer; transition: background-color 0.2s; }
        .dropdown-item:hover { background-color: var(--primary-bg); }

        .copy-feedback { position: fixed; top: 20px; left: 50%; background-color: #28a745; color: white; padding: 10px 20px; border-radius: 8px; opacity: 0; transform: translate(-50%, -10px);  transition: opacity 0.3s ease-out, transform 0.3s ease-out; z-index: 2002; pointer-events: none; }
        .copy-feedback.show { opacity: 1; transform: translate(-50%, 0); }

        /* --- 文件预览窗口样式 (有修改) --- */
        #viewer-modal-overlay { z-index: 2000; background-color: rgba(0,0,0,0.8); }
        #viewer-header { position: absolute; top: 0; left: 0; right: 0; padding: 15px 20px; background-color: rgba(20,20,20,0.7); display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; }
        #viewer-filename { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #close-viewer-btn { font-size: 1.5em; cursor: pointer; padding: 5px; line-height: 1; }
        
        #viewer-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px 20px;
            background-color: rgba(20, 20, 20, 0.7);
            color: white;
            z-index: 10;
            text-align: center;
            font-size: 0.9em;
            pointer-events: none;
        }
        
        #viewer-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 80px 20px 60px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        #viewer-content img,
        #viewer-content video,
        #viewer-content audio,
        #viewer-content iframe {
            max-width: 100%;
            max-height: 100%;
            border: none;
            object-fit: contain;
        }
        #viewer-content canvas {
            max-width: 95%;
            height: auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #viewer-content canvas:not(:first-child) {
            margin-top: 20px;
        }
        
        #viewer-content pre { width: 100%; height: 100%; background-color: #1e1e1e; color: #d4d4d4; padding: 20px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; box-sizing: border-box; }
        .unsupported-preview { color: white; text-align: center; margin-top: 40px; }
        .unsupported-preview p { margin-bottom: 20px; }
        .unsupported-preview .download-btn { background-color: var(--button-bg); color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--button-bg);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 80px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .docx-preview-container {
            font-family: Georgia, 'Times New Roman', Times, serif;
            background-color: #ffffff;
            color: #000000;
            padding: 40px 50px;
            border-radius: 5px;
            max-width: 840px;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.7;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            margin: 0 auto 20px auto;
        }
        .docx-preview-container h1, .docx-preview-container h2, .docx-preview-container h3, .docx-preview-container h4, .docx-preview-container h5, .docx-preview-container h6 {
            font-family: 'Segoe UI', Arial, sans-serif;
            color: #222;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            line-height: 1.3;
        }
        .docx-preview-container h1 { font-size: 2em; border-bottom: 2px solid #eee; padding-bottom: 0.3em; }
        .docx-preview-container h2 { font-size: 1.6em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
        .docx-preview-container h3 { font-size: 1.3em; }
        .docx-preview-container h4 { font-size: 1.1em; color: #444; }
        .docx-preview-container p { margin-bottom: 1.2em; }
        .docx-preview-container p:last-child { margin-bottom: 0; }
        .docx-preview-container ul, .docx-preview-container ol { padding-left: 2em; margin-bottom: 1.2em; }
        .docx-preview-container li { margin-bottom: 0.5em; }
        .docx-preview-container a { color: #005a9c; text-decoration: underline; }
        .docx-preview-container a:hover { color: #003366; }
        .docx-preview-container table { border-collapse: collapse; width: 100%; margin-bottom: 1.5em; font-size: 0.95em; }
        .docx-preview-container td, .docx-preview-container th { border: 1px solid #cccccc; padding: 10px 12px; text-align: left; }
        .docx-preview-container th { background-color: #f3f3f3; font-weight: bold; }

        /* HTML 预览弹窗样式 (F4) */
#html-viewer-modal {
    max-width: 95vw; /* (新) 修改: 80vw -> 95vw，让弹窗更宽 */
    width: 800px;
    padding: 20px;   /* (新) 新增: 覆盖 .modal 的 30px 40px padding */
}
        #html-viewer-content {
            /* (F1) 移除: min-height: 400px; (真的移除了) */
            max-height: 70vh;
            overflow-y: auto;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0;
            line-height: var(--line-height);
            position: relative; /* (F1) 新增: 修正样式错位问题 */
        }
    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar"> <div class="sidebar-header"> <h2>分组</h2> <div class="sidebar-actions"> <button id="import-btn">导入</button> <button id="export-btn">导出</button> </div> </div> <input type="file" id="import-file-input" accept=".json" style="display: none;"> <ul id="group-list"></ul> <div class="theme-customizer"> <h3>主题颜色</h3> <div id="preset-colors"></div> <div class="custom-color-wrapper"> <label for="custom-color-picker">自定义</label> <input type="color" id="custom-color-picker" value="#4069bf"> </div> </div> </aside>
    <div id="sidebar-overlay"></div>
    <div class="container"> <main class="main-content"> <header class="main-header"> <span id="hamburger-menu">☰</span> <div class="multi-search-wrapper" id="multi-search-wrapper"> <input type="text" id="search-input" placeholder="搜索内容、文件名、分组、备注..."> </div> <button id="search-filter-btn" title="按分组筛选">▽</button> </header> <div id="items-container"></div> </main> </div>
    
    <div id="search-filter-modal" class="search-filter-modal">
        <h3>按分组筛选</h3>
        <div id="search-filter-list"></div>
        <div class="search-filter-actions">
            <button id="search-filter-clear">清除</button>
            <button id="search-filter-apply">应用</button>
        </div>
    </div>

    <button id="add-note-btn">+</button>
    <div class="modal-overlay" id="note-modal-overlay"> <div class="modal" id="note-modal"> <h3 id="modal-title">添加新文案</h3> <form id="note-form"> <input type="hidden" id="note-id"> <div class="form-group"> <label for="note-content">内容 (必填)</label> <textarea id="note-content" required></textarea> </div> <div class="form-group group-form-group"> <label for="note-group">分组</label> <div class="group-input-wrapper"><input type="text" id="note-group" placeholder="输入新分组" autocomplete="off"><button type="button" class="group-dropdown-toggle">▼</button></div> <div id="note-group-dropdown" class="group-dropdown"></div> </div> <div class="form-group"> <label for="note-remark">备注</label> <input type="text" id="note-remark" placeholder="例如：这是一个转盘"> </div> <div class="form-divider"><span>或</span></div> <div class="form-group"> <label>存放文件</label> <button type="button" id="upload-file-btn">点击选择文件</button> <input type="file" id="file-input" style="display: none;"> </div> <div class="modal-buttons"> <button type="button" id="cancel-btn">取消</button> <button type="submit" id="save-note-btn">保存</button> </div> </form> </div> </div>
    <div class="modal-overlay" id="file-modal-overlay"> <div class="modal" id="file-modal"> <h3 id="file-modal-title">文件详情</h3> <form id="file-form"> <input type="hidden" id="file-id"> <div class="form-group"> <label for="file-name-display">文件名</label> <input type="text" id="file-name-display" required> </div> <div class="form-group group-form-group"> <label for="file-group">分组</label> <div class="group-input-wrapper"><input type="text" id="file-group" placeholder="输入新分组" autocomplete="off"><button type="button" class="group-dropdown-toggle">▼</button></div> <div id="file-group-dropdown" class="group-dropdown"></div> </div> <div class="form-group"> <label for="file-remark">备注</label> <input type="text" id="file-remark" placeholder="添加备注..."> </div> <div class="modal-buttons"> <button type="button" id="cancel-file-btn">取消</button> <button type="submit" id="save-file-btn">保存文件</button> </div> </form> </div> </div>
    <div class="modal-overlay" id="import-options-modal-overlay"> <div class="modal" id="import-options-modal"> <h3>导入选项</h3> <form> <div class="form-group"> <div class="radio-group"> <label class="radio-label"> <input type="radio" name="import-mode" value="overwrite" checked> <strong>覆盖</strong> <small>覆盖当前所有文案与文件。</small> </label> <label class="radio-label"> <input type="radio" name="import-mode" value="append"> <strong>添加</strong> <small>在现有基础上，添加新内容。</small> </label> </div> </div> <div class="modal-buttons"> <button type="button" id="import-options-cancel-btn">取消</button> <button type="button" id="import-select-file-btn">选择文件</button> </div> </form> </div> </div>
    <div class="modal-overlay" id="confirm-modal-overlay"> <div class="modal" id="confirm-modal"> <div class="confirm-modal-content"> <p id="confirm-modal-text">确定要删除吗？</p> <div class="modal-buttons" id="confirm-modal-buttons"> <button id="confirm-no">取消</button> <button id="confirm-yes">确定</button> </div> </div> </div> </div>
    <div class="modal-overlay" id="info-modal-overlay"> <div class="modal" id="info-modal"> <div class="info-modal-content"> <p id="info-modal-text">这里是提示信息</p> <div class="modal-buttons"> <button id="info-ok-btn">好的</button> </div> </div> </div> </div>
    <div class="modal-overlay" id="viewer-modal-overlay"> <div id="viewer-header"> <span id="viewer-filename"></span> <span id="close-viewer-btn">&times;</span> </div> <div id="viewer-content"></div> <div id="viewer-footer"> <span id="viewer-page-indicator"></span> </div> </div>
    <div class="copy-feedback" id="copy-feedback">已复制！</div>

    <div class="modal-overlay" id="html-viewer-overlay">
        <div class="modal" id="html-viewer-modal">
            <h3>HTML 预览</h3>
            <div id="html-viewer-content"></div>
            <div class="modal-buttons">
                <button id="html-viewer-close-btn" style="flex: 0.5;">关闭</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- IndexedDB 数据库设置 ---
            let db; const DB_NAME = 'files-db'; const STORE_NAME = 'files-store';
            function initDB() { return new Promise((resolve, reject) => { const request = indexedDB.open(DB_NAME, 1); request.onupgradeneeded = e => { const db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) { db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true }); } }; request.onsuccess = e => { db = e.target.result; resolve(db); }; request.onerror = e => reject('Database error: ' + e.target.errorCode); }); }
            function getStore(mode) { return db.transaction(STORE_NAME, mode).objectStore(STORE_NAME); }
            const dbActions = { add: (item) => new Promise((res, rej) => { const r = getStore('readwrite').add(item); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }), getAll: () => new Promise((res, rej) => { const r = getStore('readonly').getAll(); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }), update: (item) => new Promise((res, rej) => { const r = getStore('readwrite').put(item); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }), delete: (id) => new Promise((res, rej) => { const r = getStore('readwrite').delete(id); r.onsuccess = () => res(); r.onerror = () => rej(r.error); }), clear: () => new Promise((res, rej) => { const r = getStore('readwrite').clear(); r.onsuccess = () => res(); r.onerror = () => rej(r.error); }), };
            
            // --- DOM 元素获取 (新增 F3 和 F4 的元素) ---
            const docBody = document.body, docRoot = document.documentElement, itemsContainer = document.getElementById('items-container'), groupList = document.getElementById('group-list'), /* (新) 移除 searchBox */ addNoteBtn = document.getElementById('add-note-btn'), noteModalOverlay = document.getElementById('note-modal-overlay'), noteForm = document.getElementById('note-form'), modalTitle = document.getElementById('modal-title'), cancelBtn = document.getElementById('cancel-btn'), noteIdInput = document.getElementById('note-id'), noteContentInput = document.getElementById('note-content'), noteGroupInput = document.getElementById('note-group'), noteRemarkInput = document.getElementById('note-remark'), noteGroupDropdown = document.getElementById('note-group-dropdown'), uploadFileBtn = document.getElementById('upload-file-btn'), fileInput = document.getElementById('file-input'), fileModalOverlay = document.getElementById('file-modal-overlay'), fileForm = document.getElementById('file-form'), fileModalTitle = document.getElementById('file-modal-title'), fileIdInput = document.getElementById('file-id'), fileNameDisplay = document.getElementById('file-name-display'), fileGroupInput = document.getElementById('file-group'), fileRemarkInput = document.getElementById('file-remark'), fileGroupDropdown = document.getElementById('file-group-dropdown'), cancelFileBtn = document.getElementById('cancel-file-btn'), confirmModalOverlay = document.getElementById('confirm-modal-overlay'), confirmModalText = document.getElementById('confirm-modal-text'), confirmYesBtn = document.getElementById('confirm-yes'), confirmNoBtn = document.getElementById('confirm-no'), infoModalOverlay = document.getElementById('info-modal-overlay'), infoModalText = document.getElementById('info-modal-text'), infoOkBtn = document.getElementById('info-ok-btn'), importBtn = document.getElementById('import-btn'), exportBtn = document.getElementById('export-btn'), importFileInput = document.getElementById('import-file-input'), importOptionsModalOverlay = document.getElementById('import-options-modal-overlay'), importSelectFileBtn = document.getElementById('import-select-file-btn'), importOptionsCancelBtn = document.getElementById('import-options-cancel-btn'), hamburgerMenu = document.getElementById('hamburger-menu'), sidebar = document.getElementById('sidebar'), sidebarOverlay = document.getElementById('sidebar-overlay'), copyFeedback = document.getElementById('copy-feedback'), presetColorsContainer = document.getElementById('preset-colors'), customColorPicker = document.getElementById('custom-color-picker'), viewerModalOverlay = document.getElementById('viewer-modal-overlay'), viewerHeader = document.getElementById('viewer-header'), viewerFilename = document.getElementById('viewer-filename'), closeViewerBtn = document.getElementById('close-viewer-btn'), viewerContent = document.getElementById('viewer-content'), viewerPageIndicator = document.getElementById('viewer-page-indicator');
            // (新) 多关键词搜索
            const searchInput = document.getElementById('search-input'), searchWrapper = document.getElementById('multi-search-wrapper');
            // 新增 (F3)
            const searchFilterBtn = document.getElementById('search-filter-btn'), searchFilterModal = document.getElementById('search-filter-modal'), searchFilterList = document.getElementById('search-filter-list'), searchFilterClear = document.getElementById('search-filter-clear'), searchFilterApply = document.getElementById('search-filter-apply');
            // 新增 (F4)
            const htmlViewerOverlay = document.getElementById('html-viewer-overlay'), htmlViewerContent = document.getElementById('html-viewer-content'), htmlViewerCloseBtn = document.getElementById('html-viewer-close-btn');

            // --- 数据与状态 (新增 F3 的状态) ---
            let notes = [], files = [], groupOrder = [], currentFilterGroup = 'all', confirmCallback = null, tempFile = null, currentObjectUrl = null;
            let currentPdfDoc = null;
            let viewerScrollHandler = null;
            let searchFilterGroups = []; // 新增 (F3)
            let searchKeywords = []; // (新) 多关键词

            // --- 主题美化 ---
            const presetThemes = [ { name: '默认 · 宝蓝', hue: 215, sat: 50, light: 50, value: '#4069bf' }, { name: '草莓奶昔', hue: 345, sat: 80, light: 88, value: '#fcdbe4' }, { name: '奶油黄', hue: 55, sat: 75, light: 75, value: '#f2e6a4' }, { name: '薄荷马卡龙', hue: 150, sat: 55, light: 85, value: '#c7f2de' }, { name: '海盐冰淇淋', hue: 195, sat: 70, light: 82, value: '#bce6f7' }, { name: '香芋布丁', hue: 260, sat: 65, light: 88, value: '#e6dff9' }, { name: '蜜桃苏打', hue: 20, sat: 90, light: 80, value: '#fcd3c4' }, { name: '宝宝蓝', hue: 210, sat: 70, light: 80, value: '#b8d6f5' }, { name: '抹茶拿铁', hue: 95, sat: 35, light: 80, value: '#d5e6c7' }, { name: '焦糖饼干', hue: 30, sat: 50, light: 75, value: '#e6ccb3' }, ];
            const applyTheme = (h, s, l) => { docRoot.style.setProperty('--theme-hue', h); docRoot.style.setProperty('--theme-sat', `${s}%`); docRoot.style.setProperty('--theme-light', `${l}%`); localStorage.setItem('theme', JSON.stringify({ hue: h, sat: s, light: l })); };
            const loadTheme = () => { const t = JSON.parse(localStorage.getItem('theme')) || presetThemes[0]; applyTheme(t.hue, t.sat, t.light); presetColorsContainer.innerHTML = ''; presetThemes.forEach(theme => { const d = document.createElement('div'); d.className = 'preset-dot'; d.style.backgroundColor = theme.value; d.title = theme.name; d.addEventListener('click', () => applyTheme(theme.hue, theme.sat, theme.light)); presetColorsContainer.appendChild(d); }); };

            // --- 新增辅助函数 (F2, F4) ---
            /** (F2) 格式化时间戳 */
            const formatTimestamp = (isoString) => {
                if (!isoString) return '';
                try {
                    const d = new Date(isoString);
                    // 补全 YYYY-MM-DD HH:MM:SS 格式
                    return d.toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                        hour12: false
                    }).replace(/\//g, '-');
                } catch(e) {
                    console.error('Invalid timestamp:', isoString, e);
                    return '';
                }
            };
            /** (F4) 检查是否包含HTML */
            const containsHTML = (str) => /<[a-z][\s\S]*>/i.test(str);

            // --- 数据管理 ---
            const saveNotes = () => localStorage.setItem('notes-app-data', JSON.stringify(notes));
            const saveGroupOrder = () => localStorage.setItem('group-order-data', JSON.stringify(groupOrder));
            const getAllGroups = () => { const ng = notes.map(n => n.group?.trim()); const fg = files.map(f => f.group?.trim()); return [...new Set([...ng, ...fg].filter(g => g))]; };
            const saveSearchFilter = () => localStorage.setItem('search-filter-groups', JSON.stringify(searchFilterGroups)); // 新增 (F3)

            // --- 渲染函数 ---
            
            /** (F1, F3) renderGroups (已修改) - 增加分组计数 (F1), 调整样式 (F3) */
            const renderGroups = () => {
                const allGroups = getAllGroups();
                groupOrder = groupOrder.filter(g => allGroups.includes(g));
                allGroups.forEach(g => { if (!groupOrder.includes(g)) groupOrder.push(g); });
                saveGroupOrder();

                // (F1) 新增: 计算所有分组的数量
                const all = [...notes, ...files];
                const groupCounts = {
                    'all': all.length,
                    'notes_only': notes.length,
                    'files_only': files.length
                };
                all.forEach(item => {
                    if (item.group) {
                        groupCounts[item.group] = (groupCounts[item.group] || 0) + 1;
                    }
                });

                groupList.innerHTML = '';
                const staticGroups = [ { key: 'all', text: '所有条目' }, { key: 'notes_only', text: '文案' }, { key: 'files_only', text: '文件' } ];
                
                staticGroups.forEach(g => {
                    const li = document.createElement('li');
                    li.dataset.group = g.key;
                    // (F1, F3) 修改: 插入 span 和 count
                    li.innerHTML = `<span>${g.text}</span> <span class="group-count">${groupCounts[g.key] || 0}</span>`;
                    if (g.key === currentFilterGroup) li.classList.add('active');
                    groupList.appendChild(li);
                });
                
                if (groupOrder.length > 0) {
                    const d = document.createElement('div'); d.className = 'divider';
                    groupList.appendChild(d);
                    groupOrder.forEach(g => {
                        const li = document.createElement('li');
                        li.dataset.group = g;
                        // (F1, F3) 修改: 插入 span 和 count
                        li.innerHTML = `<span>${g}</span> <span class="group-count">${groupCounts[g] || 0}</span>`;
                        li.draggable = true;
                        li.classList.add('draggable');
                        if (g === currentFilterGroup) li.classList.add('active');
                        groupList.appendChild(li);
                    });
                }
            };

            const applyCollapsibleLogic = () => { const allContentDivs = itemsContainer.querySelectorAll('.note-content'); allContentDivs.forEach(div => { const computedStyle = getComputedStyle(div); const lineHeight = parseFloat(computedStyle.lineHeight); if (div.scrollHeight > (lineHeight * 5)) { div.classList.add('collapsible'); } }); };
            
            /** (F3, 新) renderItems (已修改) - 增加搜索筛选逻辑, 适配多关键词 */
            const renderItems = () => {
                const all = [...notes, ...files].sort((a, b) => b.id - a.id);
                
                // (新) 多关键词搜索
                const currentTerm = searchInput.value.trim().toLowerCase();
                const allTerms = [...searchKeywords.map(k => k.toLowerCase())];
                if (currentTerm) {
                   allTerms.push(currentTerm);
                }
                
                const filtered = all.filter(i => {
                    // 1. 侧边栏分组筛选 (视图)
                    const sidebarGroupMatch = currentFilterGroup === 'all' || (currentFilterGroup === 'notes_only' && i.type === 'note') || (currentFilterGroup === 'files_only' && i.type === 'file') || i.group === currentFilterGroup;
                    if (!sidebarGroupMatch) return false;

                    // 2. 搜索框分组筛选 (F3)
                    const searchGroupMatch = searchFilterGroups.length === 0 || (i.group && searchFilterGroups.includes(i.group));
                    if (!searchGroupMatch) return false;

                    // 3. 搜索框文字筛选 (多关键词)
                    if (allTerms.length === 0) return true; // 通过了所有分组筛选，且没有文字，则显示

                    let searchableText;
                    if (i.type === 'note') {
                        searchableText = [i.content, i.group, i.remark].join(' ').toLowerCase();
                    } else {
                        searchableText = [i.filename, i.group, i.remark].join(' ').toLowerCase();
                    }

                    // (新) 必须 *所有* 关键词都存在
                    return allTerms.every(term => searchableText.includes(term));
                });

                itemsContainer.innerHTML = '';
                if (filtered.length === 0) {
                    itemsContainer.innerHTML = '<p style="color: var(--subtle-text-color); grid-column: 1 / -1; text-align: center; margin-top: 50px;">没有找到匹配的条目哦。</p>';
                } else {
                    // (新) 传递 allTerms 用于高亮
                    filtered.forEach(i => itemsContainer.appendChild(i.type === 'note' ? createNoteCard(i, allTerms) : createFileCard(i, allTerms)));
                }
                applyCollapsibleLogic();
            };

            const escapeHTML = (str) => { const p = document.createElement('p'); p.textContent = str; return p.innerHTML; };
            
            /** (新) highlightText (已修改) - 适配多关键词高亮 */
            const highlightText = (text, terms) => {
                const safeText = escapeHTML(text || '');
                if (!terms || terms.length === 0) return safeText;
                
                // (新) 过滤掉空字符串，并对特殊字符进行转义
                const escapedTerms = terms
                    .filter(t => t.length > 0)
                    .map(term => term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
                
                if (escapedTerms.length === 0) return safeText;

                // (新) 创建一个匹配所有关键词的正则表达式
                const regex = new RegExp(`(${escapedTerms.join('|')})`, 'gi');
                return safeText.replace(regex, match => `<mark class="highlight">${match}</mark>`);
            };
            
            /** (新) createNoteCard (已修改) - 移除“编辑于”, 适配多关键词高亮 */
            function createNoteCard(note, terms) { // (新) term -> terms
                const c = document.createElement('div');
                c.className = 'note-card'; c.dataset.id = note.id; c.dataset.type = 'note';
                
                // (新) 构造时间戳HTML (只显示创建)
                const createdAt = note.createdAt ? formatTimestamp(note.createdAt) : formatTimestamp(new Date(note.id).toISOString()); // 兼容旧数据
                const timestampsHTML = `<div class="item-timestamps">
                    ${createdAt ? `<div class="timestamp">${createdAt}</div>` : ''}
                </div>`;
                
                // (F4) 检查是否有HTML
                const hasHTML = containsHTML(note.content);
                // (F2) 修改: 替换emoji为文字
                const previewBtnHTML = hasHTML ? `<button class="preview-btn" title="预览HTML">预览</button>` : '';

                c.innerHTML = `
                    <div class="note-content">${highlightText(note.content, terms)}</div>
                    <div>
                        <div class="item-footer">${note.group ? `<span class="group">${highlightText(note.group || '', terms)}</span>` : ''}<span>${highlightText(note.remark || '', terms)}</span></div>
                        <div class="item-actions">
                            ${timestampsHTML} ${previewBtnHTML} <button class="copy-btn">复制</button>
                            <button class="edit-btn">编辑</button>
                            <button class="delete-btn">删除</button>
                        </div>
                    </div>`;
                return c;
            }

            /** (新) createFileCard (已修改) - 移除“编辑于”, 适配多关键词高亮 */
            function createFileCard(file, terms) { // (新) term -> terms
                const c = document.createElement('div');
                c.className = 'file-card'; c.dataset.id = file.id; c.dataset.type = 'file';
                const size = file.file ? `${(file.file.size / 1024).toFixed(2)} KB` : 'N/A';
                
                // (新) 构造时间戳HTML (只显示创建)
                const createdAt = file.createdAt ? formatTimestamp(file.createdAt) : ''; // 文件id不是时间戳, 不做兼容
                const timestampsHTML = `<div class="item-timestamps">
                    ${createdAt ? `<div class="timestamp">${createdAt}</div>` : ''}
                </div>`;

                c.innerHTML = `
                    <div class="file-info"><span class="icon">📄</span><div class="file-details"><div class="filename">${highlightText(file.filename, terms)}</div><div class="file-size">${size}</div></div></div>
                    <div>
                        <div class="item-footer">${file.group ? `<span class="group">${highlightText(file.group || '', terms)}</span>` : ''}<span>${highlightText(file.remark || '', terms)}</span></div>
                        <div class="item-actions">
                            ${timestampsHTML} <button class="download-btn">下载</button>
                            <button class="edit-btn">编辑</button>
                            <button class="delete-btn">删除</button>
                        </div>
                    </div>`;
                return c;
            }
            
            const renderGroupDropdown = (input, dropdown) => { const f = input.value.toLowerCase(); const g = getAllGroups().filter(grp => grp.toLowerCase().includes(f)); dropdown.innerHTML = ''; if (g.length > 0) { [...new Set(g)].forEach(grp => { const i = document.createElement('div'); i.className = 'dropdown-item'; i.textContent = grp; i.addEventListener('mousedown', () => { input.value = grp; dropdown.classList.remove('visible'); }); dropdown.appendChild(i); }); dropdown.classList.add('visible'); } else { dropdown.classList.remove('visible'); } };
            
            // --- 事件处理 ---
            
            /** (新) noteForm submit (已修改) - 移除 modifiedAt */
            noteForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = noteIdInput.value;
                const content = noteContentInput.value.trim();
                if (!content) { showInfoModal('内容不能为空哦！'); return; }
                const d = { type: 'note', content, group: noteGroupInput.value.trim(), remark: noteRemarkInput.value.trim() };
                
                if (id) {
                    const idx = notes.findIndex(n => n.id == id);
                    if (idx > -1) {
                        notes[idx] = { ...notes[idx], ...d }; // (新) 移除 modifiedAt
                    }
                } else {
                    const newNote = { id: Date.now(), createdAt: new Date().toISOString(), ...d }; // (F2) 新增 createdAt
                    notes.unshift(newNote);
                }
                saveNotes();
                refreshUI();
                hideNoteModal();
            });

            /** (新) fileForm submit (已修改) - 移除 modifiedAt */
            fileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const filename = fileNameDisplay.value.trim();
                if (!filename) { showInfoModal('文件名不能为空！'); return; }
                const id = parseInt(fileIdInput.value, 10);
                const d = { type: 'file', filename, group: fileGroupInput.value.trim(), remark: fileRemarkInput.value.trim() };
                
                if (id) {
                    const ef = files.find(f => f.id === id);
                    // (新) 移除 d.modifiedAt
                    await dbActions.update({ ...ef, ...d });
                } else {
                    if (!tempFile) { showInfoModal('文件不存在，请重新选择。'); return; }
                    d.file = tempFile;
                    d.createdAt = new Date().toISOString(); // (F2) 新增 createdAt
                    await dbActions.add(d);
                }
                tempFile = null;
                await refreshUI();
                hideFileModal();
            });

            uploadFileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => { const f = e.target.files[0]; if (!f) return; tempFile = f; hideNoteModal(); showFileModal('add'); });
            
            /** (F4) itemsContainer click (已修改) - 增加预览按钮事件 */
            itemsContainer.addEventListener('click', async (e) => {
                const card = e.target.closest('.note-card, .file-card');
                if (!card) return;
                const id = parseInt(card.dataset.id, 10);
                const type = card.dataset.type;
                const targetIsActionButton = e.target.closest('.item-actions');
                const targetIsCollapsible = e.target.closest('.note-content.collapsible');
                
                if (targetIsCollapsible) {
                    if (targetIsCollapsible.classList.contains('expanded')) {
                        targetIsCollapsible.classList.remove('expanded');
                        targetIsCollapsible.style.maxHeight = null;
                    } else {
                        targetIsCollapsible.classList.add('expanded');
                        targetIsCollapsible.style.maxHeight = targetIsCollapsible.scrollHeight + 'px';
                    }
                    return;
                }
                if (type === 'file' && !targetIsActionButton) {
                    const file = files.find(f => f.id === id);
                    if(file) showViewer(file);
                    return;
                }
                if (targetIsActionButton) {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    if (btn.classList.contains('delete-btn')) {
                        showConfirmModal(type === 'note' ? '确定要删除这条文案吗？' : '确定要删除这个文件吗？', async (c) => {
                            if (c) {
                                if (type === 'note') {
                                    notes = notes.filter(n => n.id !== id);
                                    saveNotes();
                                } else {
                                    await dbActions.delete(id);
                                }
                                await refreshUI();
                            }
                        }, { danger: true, yesText: '删除' });
                    } else if (btn.classList.contains('edit-btn')) {
                        if (type === 'note') {
                            const n = notes.find(n => n.id === id);
                            if (n) showNoteModal('edit', n);
                        } else {
                            const f = files.find(f => f.id === id);
                            if (f) showFileModal('edit', f);
                        }
                    } else if (btn.classList.contains('copy-btn')) {
                        const n = notes.find(n => n.id === id);
                        if (n) copyToClipboard(n.content);
                    } else if (btn.classList.contains('download-btn')) {
                        const f = files.find(f => f.id === id);
                        if (f?.file) {
                            const url = URL.createObjectURL(f.file);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = f.filename;
                            a.click();
                            URL.revokeObjectURL(url);
                        }
                    } else if (btn.classList.contains('preview-btn')) { // (F4) 新增
                        const n = notes.find(n => n.id === id);
                        if (n) showHtmlViewer(n.content);
                    }
                }
            });
            
            // --- 导入/导出功能 ---
            const blobToBase64 = b => new Promise((res, rej) => { const r = new FileReader(); r.readAsDataURL(b); r.onload = () => res(r.result); r.onerror = e => rej(e); });
            const base64ToBlob = async (b64) => { const r = await fetch(b64); return await r.blob(); };
            exportBtn.addEventListener('click', async () => { if (notes.length === 0 && files.length === 0) { showInfoModal('没有数据可以导出。'); return; } showInfoModal('正在准备导出数据，请稍候...'); const filesForExport = []; for (const f of files) { if (f.file) { const b64 = await blobToBase64(f.file); filesForExport.push({ ...f, file: b64 }); } } const data = { notes, files: filesForExport, groupOrder, theme: JSON.parse(localStorage.getItem('theme')) || presetThemes[0] }; const str = JSON.stringify(data); const blob = new Blob([str], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); const d = new Date(); a.download = `数据备份_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.json`; a.href = url; a.click(); URL.revokeObjectURL(url); showInfoModal('数据已开始导出！'); closeSidebar(); });
            importBtn.addEventListener('click', () => showModal(importOptionsModalOverlay));
            importOptionsCancelBtn.addEventListener('click', () => hideModal(importOptionsModalOverlay));
            importSelectFileBtn.addEventListener('click', () => { hideModal(importOptionsModalOverlay); importFileInput.click(); });
            importFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (event) => { try { const parsedData = JSON.parse(event.target.result); let iN, iF, iGo, iT; if (Array.isArray(parsedData)) { iN = parsedData; iF = []; iGo = []; iT = null; } else { iN = parsedData.notes || []; iF = parsedData.files || []; iGo = parsedData.groupOrder || []; iT = parsedData.theme; } const mode = document.querySelector('input[name="import-mode"]:checked').value; const handleOverwrite = async () => { notes = iN; groupOrder = iGo; saveNotes(); saveGroupOrder(); await dbActions.clear(); for (const f of iF) { f.file = await base64ToBlob(f.file); delete f.id; await dbActions.add(f); } if (iT) { applyTheme(iT.hue, iT.sat, iT.light); loadTheme(); } await refreshUI(); showInfoModal('数据已成功覆盖！'); }; if (mode === 'overwrite') { showConfirmModal('此操作将覆盖所有文案和文件，确定吗？', (c) => { if (c) handleOverwrite(); }, { danger: true, yesText: '确定覆盖' }); } else { const existingNoteContents = new Set(notes.map(n => n.content)); const nonDuplicateNotes = iN.filter(n => !existingNoteContents.has(n.content)); const existingFilenames = new Set(files.map(f => f.filename)); const nonDuplicateFiles = iF.filter(f => !existingFilenames.has(f.filename)); const dupCount = (iN.length - nonDuplicateNotes.length) + (iF.length - nonDuplicateFiles.length); const handleAppend = async (addAll) => { const notesToAdd = addAll ? iN : nonDuplicateNotes; const filesToAdd = addAll ? iF : nonDuplicateFiles; notes.push(...notesToAdd); iGo.forEach(g => { if(!groupOrder.includes(g)) groupOrder.push(g) }); saveNotes(); saveGroupOrder(); for (const f of filesToAdd) { f.file = await base64ToBlob(f.file); delete f.id; await dbActions.add(f); } await refreshUI(); showInfoModal(`${notesToAdd.length + filesToAdd.length}个新项目已成功添加！`); }; if (dupCount > 0) { showConfirmModal(`发现 ${dupCount} 个重复项目。`, c => handleAppend(c), { yesText: '全部添加', noText: '跳过重复' }); } else { handleAppend(false); } } } catch (err) { showInfoModal('导入失败！请确保是正确的备份文件。'); console.error(err); } finally { e.target.value = ''; closeSidebar(); } }; reader.readText(file); });
            
            // --- 弹窗、侧边栏、预览等UI控制 ---
            const showModal = (o) => { o.classList.add('visible'); docBody.classList.add('modal-open'); };
            const hideModal = (o) => { o.classList.remove('visible'); docBody.classList.remove('modal-open'); };
            const showNoteModal = (mode = 'add', note = null) => { noteForm.reset(); modalTitle.textContent = mode === 'edit' ? '编辑文案' : '添加新文案'; noteIdInput.value = note?.id || ''; noteContentInput.value = note?.content || ''; noteGroupInput.value = note?.group || ''; noteRemarkInput.value = note?.remark || ''; showModal(noteModalOverlay); };
            const hideNoteModal = () => hideModal(noteModalOverlay);
            const showFileModal = (mode = 'add', file = null) => { fileForm.reset(); fileModalTitle.textContent = mode === 'edit' ? '编辑文件详情' : '文件详情'; fileIdInput.value = file?.id || ''; fileNameDisplay.value = file?.filename || tempFile?.name || '未知文件'; fileGroupInput.value = file?.group || ''; fileRemarkInput.value = file?.remark || ''; showModal(fileModalOverlay); };
            const hideFileModal = () => hideModal(fileModalOverlay);
            const showConfirmModal = (msg, cb, opt={}) => { confirmModalText.textContent = msg; confirmYesBtn.textContent = opt.yesText || '确定'; confirmNoBtn.textContent = opt.noText || '取消'; confirmCallback = cb; showModal(confirmModalOverlay); };
            const hideConfirmModal = () => hideModal(confirmModalOverlay);
            const showInfoModal = (msg) => { infoModalText.textContent = msg; showModal(infoModalOverlay); };
            const hideInfoModal = () => hideModal(infoModalOverlay);
            
            /** (F4) 新增: HTML 预览弹窗控制 (已修改为iframe沙盒模式) */
            const showHtmlViewer = (htmlContent) => {
                // 1. 创建一个 iframe 来沙盒化内容
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.border = 'none';
                iframe.style.display = 'block'; // 防止默认的 inline 间距
                iframe.style.height = '65vh'; // 设置一个临时的默认高度

                // 2. 清空容器并添加 iframe
                htmlViewerContent.innerHTML = ''; 
                htmlViewerContent.appendChild(iframe);
                
                // 3. 将用户的HTML内容写入 iframe
                try {
                    const doc = iframe.contentWindow.document;
                    doc.open();
                    doc.write(htmlContent);
                    doc.close();
                } catch (e) {
                    console.error("Error writing to iframe:", e);
                    htmlViewerContent.innerHTML = '<p>预览加载失败。</p>';
                    showModal(htmlViewerOverlay);
                    return;
                }

                // 4. 动态设置 iframe 高度以适应其内容
                // 我们使用一个短暂的延迟来确保内容（尤其是样式）已经渲染
                setTimeout(() => {
                    try {
                        const body = iframe.contentWindow.document.body;
                        const html = iframe.contentWindow.document.documentElement;
                        
                        // 移除 iframe 默认的 body margin，让其紧贴边缘
                        body.style.margin = '0';

                        // 计算内容实际高度
                        const height = Math.max( 
                            body.scrollHeight, body.offsetHeight, 
                            html.clientHeight, html.scrollHeight, html.offsetHeight 
                        );
                        
                        // 设置 iframe 的高度。父 div (#html-viewer-content) 
                        // 会在内容超出 max-height (70vh) 时出现滚动条
                        iframe.style.height = (height + 2) + 'px'; // +2 像素作为缓冲

                    } catch (e) {
                        console.error("Error adjusting iframe height:", e);
                        // 如果出错，使用回退高度
                        iframe.style.height = '65vh'; 
                    }
                }, 100); // 100ms 延迟
                
                // 5. 显示弹窗
                showModal(htmlViewerOverlay);
            };

            const hideHtmlViewer = () => {
                hideModal(htmlViewerOverlay);
                // 彻底清空 iframe 内容，防止脚本或媒体继续在后台运行
                const iframe = htmlViewerContent.querySelector('iframe');
                if (iframe) {
                    // 设置为空白页，这是销毁 iframe 内容的标准方法
                    iframe.src = 'about:blank';
                }
                htmlViewerContent.innerHTML = '';
            };
            htmlViewerCloseBtn.addEventListener('click', hideHtmlViewer);
            htmlViewerOverlay.addEventListener('click', e => { if (e.target === htmlViewerOverlay) hideHtmlViewer(); });


            /** (F3) 新增: 搜索筛选弹窗控制 */
            const updateSearchFilterBtnState = () => {
                if (searchFilterGroups.length > 0) {
                    searchFilterBtn.classList.add('active');
                    searchFilterBtn.textContent = `▽ (${searchFilterGroups.length})`;
                } else {
                    searchFilterBtn.classList.remove('active');
                    searchFilterBtn.textContent = '▽';
                }
            };
            const showSearchFilterModal = () => {
                const allGroups = getAllGroups();
                if (allGroups.length === 0) {
                    searchFilterList.innerHTML = '<p style="color: var(--subtle-text-color); padding: 10px; text-align: center;">暂无分组</p>';
                } else {
                    searchFilterList.innerHTML = allGroups.map(g =>
                        `<label><input type="checkbox" value="${escapeHTML(g)}" ${searchFilterGroups.includes(g) ? 'checked' : ''}> ${escapeHTML(g)}</label>`
                    ).join('');
                }
                searchFilterModal.classList.add('visible');
            };
            const hideSearchFilterModal = () => searchFilterModal.classList.remove('visible');
            
            searchFilterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (searchFilterModal.classList.contains('visible')) {
                    hideSearchFilterModal();
                } else {
                    showSearchFilterModal();
                }
            });
            searchFilterApply.addEventListener('click', () => {
                const selected = [...searchFilterList.querySelectorAll('input:checked')].map(input => input.value);
                searchFilterGroups = selected;
                saveSearchFilter();
                updateSearchFilterBtnState();
                renderItems();
                hideSearchFilterModal();
            });
            searchFilterClear.addEventListener('click', () => {
                searchFilterGroups = [];
                saveSearchFilter();
                updateSearchFilterBtnState();
                [...searchFilterList.querySelectorAll('input:checked')].forEach(input => input.checked = false);
                renderItems();
                hideSearchFilterModal();
            });


            const showViewer = async (file) => {
                if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
                viewerFilename.textContent = file.filename;
                viewerContent.innerHTML = '';
                viewerPageIndicator.textContent = '';
                const type = file.file.type;
                const filename = file.filename.toLowerCase();
                currentObjectUrl = URL.createObjectURL(file.file);
                let element;

                if (type.startsWith('image/')) {
                    element = document.createElement('img');
                    element.src = currentObjectUrl;
                } else if (type.startsWith('video/')) {
                    element = document.createElement('video');
                    element.src = currentObjectUrl;
                    element.controls = true;
                } else if (type.startsWith('audio/')) {
                    element = document.createElement('audio');
                    element.src = currentObjectUrl;
                    element.controls = true;
                } else if (type === 'application/pdf') {
                    viewerContent.innerHTML = `<div class="loader"></div>`;
                    
                    const setupPdfViewer = async (pdfDoc) => {
                        currentPdfDoc = pdfDoc;
                        const totalPages = pdfDoc.numPages;
                        const pdfPageCanvases = [];
                        
                        viewerPageIndicator.textContent = `第 1 / ${totalPages} 页`;
                        viewerContent.innerHTML = '';
                        
                        viewerScrollHandler = () => {
                            const viewerRect = viewerContent.getBoundingClientRect();
                            let mostVisiblePage = 1;
                            let maxVisibleHeight = 0;

                            pdfPageCanvases.forEach((canvas, index) => {
                                const canvasRect = canvas.getBoundingClientRect();
                                const visibleTop = Math.max(viewerRect.top, canvasRect.top);
                                const visibleBottom = Math.min(viewerRect.bottom, canvasRect.bottom);
                                const visibleHeight = Math.max(0, visibleBottom - visibleTop);

                                if (visibleHeight > maxVisibleHeight) {
                                    maxVisibleHeight = visibleHeight;
                                    mostVisiblePage = index + 1;
                                }
                            });
                            viewerPageIndicator.textContent = `第 ${mostVisiblePage} / ${totalPages} 页`;
                        };
                        viewerContent.addEventListener('scroll', viewerScrollHandler);

                        for (let i = 1; i <= totalPages; i++) {
                            const page = await pdfDoc.getPage(i);
                            const pixelRatio = window.devicePixelRatio || 1;
                            const viewport = page.getViewport({ scale: pixelRatio * 1.5 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            const renderContext = { canvasContext: context, viewport: viewport };
                            await page.render(renderContext).promise;
                            viewerContent.appendChild(canvas);
                            pdfPageCanvases.push(canvas);
                        }
                    };
                    
                    pdfjsLib.getDocument(currentObjectUrl).promise.then(setupPdfViewer).catch(err => {
                        console.error('PDF.js error:', err);
                        viewerContent.innerHTML = `<div class="unsupported-preview"><p>无法预览此PDF文件。</p><a href="${currentObjectUrl}" download="${file.filename}" class="download-btn">下载文件</a></div>`;
                    });

                } else if (type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || filename.endsWith('.docx')) {
                    viewerContent.innerHTML = `<div class="loader"></div>`;
                    setTimeout(async () => {
                        try {
                            const arrayBuffer = await file.file.arrayBuffer();
                            const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                            const previewContainer = document.createElement('div');
                            previewContainer.className = 'docx-preview-container';
                            previewContainer.innerHTML = result.value;
                            viewerContent.innerHTML = '';
                            viewerContent.appendChild(previewContainer);

                            viewerScrollHandler = () => {
                                const { scrollTop, scrollHeight, clientHeight } = viewerContent;
                                if (clientHeight > 0) {
                                    const totalPages = Math.max(1, Math.ceil(scrollHeight / clientHeight));
                                    const isAtBottom = Math.abs(scrollHeight - scrollTop - clientHeight) < 1;
                                    let currentPage = Math.floor(scrollTop / clientHeight) + 1;
                                    if (isAtBottom) {
                                        currentPage = totalPages;
                                    }
                                    viewerPageIndicator.textContent = `第 ${currentPage} / ${totalPages} 页 (预估)`;
                                }
                            };
                            viewerContent.addEventListener('scroll', viewerScrollHandler);
                            viewerScrollHandler();

                        } catch (err) {
                            console.error('Mammoth.js error:', err);
                            viewerContent.innerHTML = `<div class="unsupported-preview"><p>无法预览此DOCX文件。</p><a href="${currentObjectUrl}" download="${file.filename}" class="download-btn">下载文件</a></div>`;
                        }
                    }, 50);
                } else if (type.startsWith('text/') || type === 'application/json') {
                    element = document.createElement('pre');
                    element.textContent = await file.file.text();
                } else {
                    viewerContent.innerHTML = `<div class="unsupported-preview"><p>无法预览此文件类型。</p><a href="${currentObjectUrl}" download="${file.filename}" class="download-btn">下载文件</a></div>`;
                }
                
                if (element) viewerContent.appendChild(element);
                showModal(viewerModalOverlay);
            };

            const hideViewer = () => {
                hideModal(viewerModalOverlay);
                viewerContent.innerHTML = '';
                if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
                currentObjectUrl = null;

                if (currentPdfDoc) {
                    currentPdfDoc.destroy();
                    currentPdfDoc = null;
                }
                
                if (viewerScrollHandler) {
                    viewerContent.removeEventListener('scroll', viewerScrollHandler);
                    viewerScrollHandler = null;
                }
            };
            cancelBtn.addEventListener('click', hideNoteModal); noteModalOverlay.addEventListener('click', e => { if (e.target === noteModalOverlay) hideNoteModal(); });
            cancelFileBtn.addEventListener('click', hideFileModal); fileModalOverlay.addEventListener('click', e => { if (e.target === fileModalOverlay) hideFileModal(); });
            confirmYesBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(true); hideConfirmModal(); }); confirmNoBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(false); hideConfirmModal(); });
            infoOkBtn.addEventListener('click', hideInfoModal); infoModalOverlay.addEventListener('click', e => { if (e.target === infoModalOverlay) hideInfoModal(); });
            closeViewerBtn.addEventListener('click', hideViewer);
            viewerModalOverlay.addEventListener('click', e => {
                if (e.target === viewerModalOverlay) {
                    hideViewer();
                }
            });
            const openSidebar = () => { sidebar.classList.add('open'); sidebarOverlay.classList.add('visible'); };
            const closeSidebar = () => { sidebar.classList.remove('open'); sidebarOverlay.classList.remove('visible'); };
            hamburgerMenu.addEventListener('click', openSidebar); sidebarOverlay.addEventListener('click', closeSidebar); addNoteBtn.addEventListener('click', () => showNoteModal('add'));
            groupList.addEventListener('click', (e) => { const li = e.target.closest('li'); if (li && li.dataset.group) { currentFilterGroup = li.dataset.group; refreshUI(); closeSidebar(); } });
            
            // --- (新) 多关键词搜索逻辑 (已修改) ---
            const renderKeywords = () => {
                // 1. 移除旧标签
                searchWrapper.querySelectorAll('.keyword-tag').forEach(tag => tag.remove());
                
                // 2. 添加新标签
                searchKeywords.forEach(keyword => {
                    const tag = document.createElement('span');
                    tag.className = 'keyword-tag';
                    const safeKeyword = escapeHTML(keyword);
                    tag.innerHTML = `
                        <span>${safeKeyword}</span>
                        <button class="remove-tag" data-keyword="${safeKeyword}" title="移除">&times;</button>
                    `;
                    // 插在 input 前面
                    searchWrapper.insertBefore(tag, searchInput);
                });
                
                // 3. 触发搜索
                renderItems();
            };

            // (新) 监听 input 事件，用于创建标签 (更兼容移动端)
            searchInput.addEventListener('input', (e) => {
                const value = searchInput.value;
                
                // 1. 检查是否以空格结尾
                if (value.endsWith(' ') && value.trim() !== '') {
                    // 是空格，创建标签
                    const keyword = value.slice(0, -1).trim(); // 获取空格前的内容
                    if (keyword && !searchKeywords.includes(keyword)) {
                        searchKeywords.push(keyword);
                    }
                    searchInput.value = ''; // 清空输入框
                    renderKeywords(); // 渲染新标签
                }
                
                // 无论如何都重新渲染条目
                renderItems();
            });

            // (新) 监听 keydown 事件，仅用于处理退格键
            searchInput.addEventListener('keydown', (e) => {
                // 2. 按下退格键 (Backspace)
                if (e.key === 'Backspace' && searchInput.value === '' && searchKeywords.length > 0) {
                    e.preventDefault();
                    const lastKeyword = searchKeywords.pop();
                    searchInput.value = lastKeyword + ' '; // 加个空格方便编辑
                    renderKeywords(); // 移除标签
                    renderItems(); // (新) 确保退格后也更新搜索
                }
            });


            searchWrapper.addEventListener('click', (e) => {
                // 3. 点击 "x" 移除标签
                if (e.target.classList.contains('remove-tag')) {
                    const keywordToRemove = e.target.dataset.keyword;
                    searchKeywords = searchKeywords.filter(k => k !== keywordToRemove);
                    renderKeywords();
                }
                // 4. 点击空白处聚焦 input
                else if (e.target === searchWrapper || e.target.classList.contains('keyword-tag')) {
                    searchInput.focus();
                }
            });
            // --- 结束 多关键词搜索逻辑 ---

            document.addEventListener('click', (e) => { // (F3) 增加点击空白处关闭搜索筛选
                if (!searchFilterModal.contains(e.target) && e.target !== searchFilterBtn) {
                    hideSearchFilterModal();
                }
            });
            
            // --- 辅助与刷新函数 ---
            const refreshUI = async () => { files = await dbActions.getAll(); renderGroups(); renderItems(); };
            let copyTimeout; const copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(() => { clearTimeout(copyTimeout); copyFeedback.classList.add('show'); copyTimeout = setTimeout(() => copyFeedback.classList.remove('show'), 1500); }).catch(() => showInfoModal('复制失败！')); };
            
            // --- 拖拽排序 ---
            let draggedItem = null;
            groupList.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('draggable')) {
                    draggedItem = e.target;
                    const rect = e.target.getBoundingClientRect();
                    const offsetX = e.clientX - rect.left;
                    const offsetY = e.clientY - rect.top;
                    e.dataTransfer.setDragImage(e.target, offsetX, offsetY);
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });
            groupList.addEventListener('dragover', (e) => { e.preventDefault(); const afterElement = getDragAfterElement(groupList, e.clientY); const current = document.querySelector('.dragging'); if (afterElement == null) { groupList.appendChild(current); } else { groupList.insertBefore(current, afterElement); } });
            groupList.addEventListener('dragend', () => { if(draggedItem) draggedItem.classList.remove('dragging'); });
            groupList.addEventListener('drop', () => { const newOrder = [...groupList.querySelectorAll('.draggable')].map(li => li.dataset.group); groupOrder = newOrder; saveGroupOrder(); });
            function getDragAfterElement(container, y) { const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }

            // --- 初始化 ---
            
            /** (F2) migrateData (已修改) - 增加旧数据时间戳兼容 */
            const migrateData = () => {
                let nc = false;
                const n = JSON.parse(localStorage.getItem('notes-app-data')) || [];
                const m = n.map(note => {
                    if (!note.type) {
                        note.type = 'note';
                        nc = true;
                    }
                    // (F2) 兼容旧数据, 用id作为createdAt
                    if (!note.createdAt) {
                        note.createdAt = new Date(note.id).toISOString();
                        nc = true;
                    }
                    return note;
                });
                if (nc) {
                    localStorage.setItem('notes-app-data', JSON.stringify(m));
                }
                notes = m;
                groupOrder = JSON.parse(localStorage.getItem('group-order-data')) || [];
            };
            
            const setupGroupInput = (input, dropdown, toggle) => {
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (dropdown.classList.contains('visible')) {
                        dropdown.classList.remove('visible');
                    } else {
                        renderGroupDropdown(input, dropdown);
                    }
                });
                input.addEventListener('focus', () => renderGroupDropdown(input, dropdown));
                input.addEventListener('input', () => renderGroupDropdown(input, dropdown));
                document.addEventListener('click', (e) => { if (!input.parentElement.contains(e.target)) dropdown.classList.remove('visible'); });
            };
            setupGroupInput(noteGroupInput, noteGroupDropdown, noteForm.querySelector('.group-dropdown-toggle'));
            setupGroupInput(fileGroupInput, fileGroupDropdown, fileForm.querySelector('.group-dropdown-toggle'));

            loadTheme();
            await initDB();
            migrateData();
            // (F3) 新增: 加载搜索筛选
            searchFilterGroups = JSON.parse(localStorage.getItem('search-filter-groups')) || [];
            updateSearchFilterBtnState();
            
            await refreshUI();
        });
    </script>
</body>
</html>
