<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文案与文件存放站</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;</script>
    <style>
        /* --- 全局与主题样式 --- */
        :root {
            /* 核心颜色变量 */
            --theme-hue: 215;
            --theme-sat: 50%;
            --theme-light: 50%;

            /* 派生颜色变量 */
            --primary-bg: hsl(var(--theme-hue), calc(var(--theme-sat) * 0.9), 95%);
            --sidebar-bg: hsl(var(--theme-hue), var(--theme-sat), 92%);
            --main-header-bg: #ffffff;
            --card-bg: #ffffff;
            --button-bg: hsl(var(--theme-hue), var(--theme-sat), var(--theme-light));
            --button-hover-bg: hsl(var(--theme-hue), var(--theme-sat), calc(var(--theme-light) - 7%));
            
            --theme-color-darker: hsl(var(--theme-hue), calc(var(--theme-sat) * 1.1), calc(var(--theme-light) * 0.7));

            --text-color: #333333;
            --subtle-text-color: #777777;
            --border-color: hsl(var(--theme-hue), calc(var(--theme-sat) * 0.7), 86%);
            --shadow-color: hsla(var(--theme-hue), 25%, 50%, 0.1);
            --highlight-bg: #fff176;
            --font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            --line-height: 1.6; /* 定义行高变量 */
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--text-color);
            line-height: var(--line-height);
            overflow-x: hidden;
            transition: background-color 0.3s;
        }
        body.modal-open { overflow: hidden; }

        /* --- 主布局 --- */
        .container { display: flex; height: 100vh; }

        .sidebar {
            width: 220px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            box-sizing: border-box;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 200;
            transform: translateX(-100%);
            transition: transform 0.35s ease-out, background-color 0.3s, border-color 0.3s;
            box-shadow: 2px 0 5px var(--shadow-color);
            user-select: none; /* 防止拖动时选中文本 */
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            flex-shrink: 0;
        }
        .sidebar-header h2 { margin: 0; font-size: 1.5em; color: var(--theme-color-darker); transition: color 0.3s; }
        .sidebar-actions { display: flex; gap: 10px; }
        .sidebar-actions button {
            background: none;
            border: 1px solid var(--theme-color-darker);
            color: var(--theme-color-darker);
            border-radius: 5px;
            padding: 3px 8px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.3s;
        }
        .sidebar-actions button:hover { background-color: var(--theme-color-darker); color: white; }

        #group-list { list-style-type: none; padding: 0; margin-top: 15px; flex-grow: 1; overflow-y: auto; }
        #group-list li {
            padding: 10px 15px;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s, opacity 0.2s, border 0.2s;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #group-list li.draggable { cursor: grab; }
        #group-list li.draggable:active { cursor: grabbing; }
        #group-list li.active { background-color: var(--button-bg); color: white; font-weight: bold; }
        #group-list .divider { height: 1px; background-color: var(--border-color); margin: 8px 0; padding: 0; }
        #group-list .dragging { opacity: 0.4; }
        #group-list .drag-over { border-top: 2px solid var(--button-bg); }


        /* 主题美化模块 */
        .theme-customizer { flex-shrink: 0; padding-top: 15px; margin-top: 15px; border-top: 1px solid var(--border-color); }
        .theme-customizer h3 { font-size: 1em; margin: 0 0 10px 0; color: var(--subtle-text-color); }
        #preset-colors { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .preset-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .preset-dot:hover { transform: scale(1.1); }
        .preset-dot.active { border-color: var(--button-bg); }
        .custom-color-wrapper { display: flex; align-items: center; gap: 10px; }
        .custom-color-wrapper label { font-size: 0.9em; }
        #custom-color-picker { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 28px; height: 28px; background-color: transparent; border: none; cursor: pointer; padding: 0; }
        #custom-color-picker::-webkit-color-swatch { border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        #custom-color-picker::-moz-color-swatch { border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; width: 100%; }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); z-index: 199; opacity: 0; visibility: hidden; transition: opacity 0.35s ease-out, visibility 0.35s ease-out; }
        #sidebar-overlay.visible { opacity: 1; visibility: visible; }

        .main-header { padding: 15px 25px 15px 15px; background-color: var(--main-header-bg); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 4px var(--shadow-color); z-index: 10; display: flex; align-items: center; gap: 12px; }
        #hamburger-menu { font-size: 1.8em; cursor: pointer; color: var(--theme-color-darker); padding: 5px; margin-right: 3px; border-radius: 5px; transition: background-color 0.2s, color 0.3s; }

        #search-box { flex-grow: 1; padding: 10px 15px; font-size: 1em; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
        #search-box:focus { outline: none; border-color: var(--button-bg); box-shadow: 0 0 5px hsla(var(--theme-hue), var(--theme-sat), var(--theme-light), 0.5); }

        #items-container { flex-grow: 1; overflow-y: auto; padding: 30px; padding-bottom: 120px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; align-content: start; }

        .note-card, .file-card { background-color: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px var(--shadow-color); display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--border-color); position: relative; }
        .note-card:hover, .file-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px hsla(var(--theme-hue), 20%, 50%, 0.15); }
        .file-card { cursor: pointer; }

        .note-content { white-space: pre-wrap; word-wrap: break-word; flex-grow: 1; margin-bottom: 15px; transition: max-height 0.35s ease-in-out; }
        .note-content.collapsible { max-height: calc(1em * var(--line-height) * 5); overflow: hidden; position: relative; cursor: pointer; }
        .note-content.collapsible:not(.expanded)::after { content: '... 点击展开'; position: absolute; bottom: 0; right: 0; background: linear-gradient(to right, transparent, var(--card-bg) 25%); padding: 0 0 2px 30px; color: var(--subtle-text-color); font-weight: bold; font-size: 0.9em; }
        
        .item-footer { border-top: 1px solid var(--border-color); padding-top: 10px; font-size: 0.9em; color: var(--subtle-text-color); }
        .item-footer .group { background-color: var(--primary-bg); padding: 3px 8px; border-radius: 4px; font-weight: bold; color: var(--theme-color-darker); margin-right: 10px; display: inline-block; transition: background-color 0.3s, color 0.3s; }

        .item-actions { margin-top: 15px; text-align: right; }
        .item-actions button { background: none; border: none; cursor: pointer; padding: 5px; margin-left: 10px; font-size: 0.9em; color: var(--subtle-text-color); transition: color 0.2s; display: inline-flex; align-items: center; gap: 3px; }
        .item-actions button:hover { color: var(--button-bg); }
        .highlight { background-color: var(--highlight-bg); border-radius: 3px; padding: 0 2px; color: #333; }

        .file-info { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-grow: 1; }
        .file-info .icon { font-size: 2.5em; color: var(--button-bg); }
        .file-details .filename { font-weight: bold; word-break: break-all; }
        .file-details .file-size { font-size: 0.8em; color: var(--subtle-text-color); }

        #add-note-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--button-bg); color: white; border: none; border-radius: 50%; font-size: 2em; line-height: 60px; text-align: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); transition: background-color 0.3s, transform 0.2s; z-index: 100; }
        #add-note-btn:hover { background-color: var(--button-hover-bg); transform: scale(1.1); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal { background-color: var(--primary-bg); padding: 30px 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25); width: 90%; max-width: 500px; transform: scale(0.9); transition: transform 0.3s, background-color 0.3s; }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal h3 { margin-top: 0; margin-bottom: 25px; font-size: 1.8em; color: var(--theme-color-darker); text-align: center; transition: color 0.3s;}
        .modal .form-group { margin-bottom: 20px; }
        .modal label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-color); }
        .modal input[type="text"], .modal textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); background-color: #fff; border-radius: 8px; font-size: 1em; font-family: var(--font-family); box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
        .modal input[type="text"]:focus, .modal textarea:focus { outline: none; border-color: var(--button-bg); box-shadow: 0 0 5px hsla(var(--theme-hue), var(--theme-sat), var(--theme-light), 0.5); }
        .modal textarea { min-height: 150px; resize: vertical; }
        .group-input-wrapper { position: relative; display: flex; align-items: center; }
        .group-input-wrapper input { padding-right: 35px !important; }
        .group-dropdown-toggle { position: absolute; right: 1px; top: 1px; bottom: 1px; width: 35px; border: none; background: transparent; color: var(--subtle-text-color); cursor: pointer; font-size: 0.8em; border-radius: 0 8px 8px 0; }
        .group-dropdown-toggle:hover { background-color: rgba(0,0,0,0.05); }

        .form-divider { text-align: center; border-bottom: 1px solid var(--border-color); line-height: 0.1em; margin: 25px 0; }
        .form-divider span { background: var(--primary-bg); padding: 0 10px; color: var(--subtle-text-color); font-size: 0.9em; transition: background-color 0.3s; }
        #upload-file-btn { width: 100%; padding: 12px; background-color: #f1f1f1; color: var(--subtle-text-color); border: 1px dashed var(--border-color); border-radius: 8px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        #upload-file-btn:hover { background-color: #e9e9e9; border-color: var(--button-bg); }

        .modal-buttons { display: flex; align-items: center; gap: 15px; margin-top: 25px; }
        .modal-buttons button { flex: 1; text-align: center; padding: 10px 15px; border-radius: 8px; border: 1px solid; font-size: 1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s, color 0.2s, transform 0.1s, border-color 0.3s; }
        .modal-buttons button:active { transform: scale(0.98); }

        #save-note-btn, #info-ok-btn, #save-file-btn, #import-select-file-btn { background-color: var(--button-bg); color: white; border-color: var(--button-bg); }
        #save-note-btn:hover, #info-ok-btn:hover, #save-file-btn:hover, #import-select-file-btn:hover { background-color: var(--button-hover-bg); border-color: var(--button-hover-bg); }
        #cancel-btn, #import-options-cancel-btn, #cancel-file-btn { background-color: #f1f1f1; color: var(--subtle-text-color); border-color: var(--border-color); }
        #cancel-btn:hover, #import-options-cancel-btn:hover, #cancel-file-btn:hover { background-color: #e0e0e0; }
        
        #confirm-yes { background-color: #e74c3c; color: white; border-color: transparent; }
        #confirm-yes:hover { background-color: #c0392b; }
        #confirm-no { background-color: #f1f1f1; color: var(--subtle-text-color); border-color: var(--border-color); }
        #confirm-no:hover { background-color: #e0e0e0; }
        
        .group-form-group { position: relative; }
        .group-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: white; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px var(--shadow-color); max-height: 160px; overflow-y: auto; z-index: 1001; }
        .group-dropdown.visible { display: block; }
        .dropdown-item { padding: 10px 12px; cursor: pointer; transition: background-color 0.2s; }
        .dropdown-item:hover { background-color: var(--primary-bg); }

        .copy-feedback { position: fixed; top: 20px; left: 50%; background-color: #28a745; color: white; padding: 10px 20px; border-radius: 8px; opacity: 0; transform: translate(-50%, -10px);  transition: opacity 0.3s ease-out, transform 0.3s ease-out; z-index: 2002; pointer-events: none; }
        .copy-feedback.show { opacity: 1; transform: translate(-50%, 0); }

        /* --- 文件预览窗口样式 (有修改) --- */
        #viewer-modal-overlay { z-index: 2000; background-color: rgba(0,0,0,0.8); }
        #viewer-header { position: absolute; top: 0; left: 0; right: 0; padding: 15px 20px; background-color: rgba(20,20,20,0.7); display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; }
        #viewer-filename { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #close-viewer-btn { font-size: 1.5em; cursor: pointer; padding: 5px; line-height: 1; }
        
        #viewer-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px 20px;
            background-color: rgba(20, 20, 20, 0.7);
            color: white;
            z-index: 10;
            text-align: center;
            font-size: 0.9em;
            pointer-events: none;
        }
        
        #viewer-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 80px 20px 60px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        #viewer-content img,
        #viewer-content video,
        #viewer-content audio,
        #viewer-content iframe {
            max-width: 100%;
            max-height: 100%;
            border: none;
            object-fit: contain;
        }
        #viewer-content canvas {
            max-width: 95%;
            height: auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #viewer-content canvas:not(:first-child) {
            margin-top: 20px;
        }
        
        #viewer-content pre { width: 100%; height: 100%; background-color: #1e1e1e; color: #d4d4d4; padding: 20px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; box-sizing: border-box; }
        .unsupported-preview { color: white; text-align: center; margin-top: 40px; }
        .unsupported-preview p { margin-bottom: 20px; }
        .unsupported-preview .download-btn { background-color: var(--button-bg); color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--button-bg);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 80px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .docx-preview-container {
            font-family: Georgia, 'Times New Roman', Times, serif;
            background-color: #ffffff;
            color: #000000;
            padding: 40px 50px;
            border-radius: 5px;
            max-width: 840px;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.7;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            margin: 0 auto 20px auto;
        }
        .docx-preview-container h1, .docx-preview-container h2, .docx-preview-container h3, .docx-preview-container h4, .docx-preview-container h5, .docx-preview-container h6 {
            font-family: 'Segoe UI', Arial, sans-serif;
            color: #222;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            line-height: 1.3;
        }
        .docx-preview-container h1 { font-size: 2em; border-bottom: 2px solid #eee; padding-bottom: 0.3em; }
        .docx-preview-container h2 { font-size: 1.6em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
        .docx-preview-container h3 { font-size: 1.3em; }
        .docx-preview-container h4 { font-size: 1.1em; color: #444; }
        .docx-preview-container p { margin-bottom: 1.2em; }
        .docx-preview-container p:last-child { margin-bottom: 0; }
        .docx-preview-container ul, .docx-preview-container ol { padding-left: 2em; margin-bottom: 1.2em; }
        .docx-preview-container li { margin-bottom: 0.5em; }
        .docx-preview-container a { color: #005a9c; text-decoration: underline; }
        .docx-preview-container a:hover { color: #003366; }
        .docx-preview-container table { border-collapse: collapse; width: 100%; margin-bottom: 1.5em; font-size: 0.95em; }
        .docx-preview-container td, .docx-preview-container th { border: 1px solid #cccccc; padding: 10px 12px; text-align: left; }
        .docx-preview-container th { background-color: #f3f3f3; font-weight: bold; }
    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar"> <div class="sidebar-header"> <h2>分组</h2> <div class="sidebar-actions"> <button id="import-btn">导入</button> <button id="export-btn">导出</button> </div> </div> <input type="file" id="import-file-input" accept=".json" style="display: none;"> <ul id="group-list"></ul> <div class="theme-customizer"> <h3>主题颜色</h3> <div id="preset-colors"></div> <div class="custom-color-wrapper"> <label for="custom-color-picker">自定义</label> <input type="color" id="custom-color-picker" value="#4069bf"> </div> </div> </aside>
    <div id="sidebar-overlay"></div>
    <div class="container"> <main class="main-content"> <header class="main-header"> <span id="hamburger-menu">☰</span> <input type="search" id="search-box" placeholder="搜索内容、文件名、分组、备注..."> </header> <div id="items-container"></div> </main> </div>
    <button id="add-note-btn">+</button>
    <div class="modal-overlay" id="note-modal-overlay"> <div class="modal" id="note-modal"> <h3 id="modal-title">添加新文案</h3> <form id="note-form"> <input type="hidden" id="note-id"> <div class="form-group"> <label for="note-content">内容 (必填)</label> <textarea id="note-content" required></textarea> </div> <div class="form-group group-form-group"> <label for="note-group">分组</label> <div class="group-input-wrapper"><input type="text" id="note-group" placeholder="输入新分组" autocomplete="off"><button type="button" class="group-dropdown-toggle">▼</button></div> <div id="note-group-dropdown" class="group-dropdown"></div> </div> <div class="form-group"> <label for="note-remark">备注</label> <input type="text" id="note-remark" placeholder="例如：这是一个转盘"> </div> <div class="form-divider"><span>或</span></div> <div class="form-group"> <label>存放文件</label> <button type="button" id="upload-file-btn">点击选择文件</button> <input type="file" id="file-input" style="display: none;"> </div> <div class="modal-buttons"> <button type="button" id="cancel-btn">取消</button> <button type="submit" id="save-note-btn">保存</button> </div> </form> </div> </div>
    <div class="modal-overlay" id="file-modal-overlay"> <div class="modal" id="file-modal"> <h3 id="file-modal-title">文件详情</h3> <form id="file-form"> <input type="hidden" id="file-id"> <div class="form-group"> <label for="file-name-display">文件名</label> <input type="text" id="file-name-display" required> </div> <div class="form-group group-form-group"> <label for="file-group">分组</label> <div class="group-input-wrapper"><input type="text" id="file-group" placeholder="输入新分组" autocomplete="off"><button type="button" class="group-dropdown-toggle">▼</button></div> <div id="file-group-dropdown" class="group-dropdown"></div> </div> <div class="form-group"> <label for="file-remark">备注</label> <input type="text" id="file-remark" placeholder="添加备注..."> </div> <div class="modal-buttons"> <button type="button" id="cancel-file-btn">取消</button> <button type="submit" id="save-file-btn">保存文件</button> </div> </form> </div> </div>
    <div class="modal-overlay" id="import-options-modal-overlay"> <div class="modal" id="import-options-modal"> <h3>导入选项</h3> <form> <div class="form-group"> <div class="radio-group"> <label class="radio-label"> <input type="radio" name="import-mode" value="overwrite" checked> <strong>覆盖</strong> <small>覆盖当前所有文案与文件。</small> </label> <label class="radio-label"> <input type="radio" name="import-mode" value="append"> <strong>添加</strong> <small>在现有基础上，添加新内容。</small> </label> </div> </div> <div class="modal-buttons"> <button type="button" id="import-options-cancel-btn">取消</button> <button type="button" id="import-select-file-btn">选择文件</button> </div> </form> </div> </div>
    <div class="modal-overlay" id="confirm-modal-overlay"> <div class="modal" id="confirm-modal"> <div class="confirm-modal-content"> <p id="confirm-modal-text">确定要删除吗？</p> <div class="modal-buttons" id="confirm-modal-buttons"> <button id="confirm-no">取消</button> <button id="confirm-yes">确定</button> </div> </div> </div> </div>
    <div class="modal-overlay" id="info-modal-overlay"> <div class="modal" id="info-modal"> <div class="info-modal-content"> <p id="info-modal-text">这里是提示信息</p> <div class="modal-buttons"> <button id="info-ok-btn">好的</button> </div> </div> </div> </div>
    <div class="modal-overlay" id="viewer-modal-overlay"> <div id="viewer-header"> <span id="viewer-filename"></span> <span id="close-viewer-btn">&times;</span> </div> <div id="viewer-content"></div> <div id="viewer-footer"> <span id="viewer-page-indicator"></span> </div> </div>
    <div class="copy-feedback" id="copy-feedback">已复制！</div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- IndexedDB 数据库设置 ---
            let db; const DB_NAME = 'files-db'; const STORE_NAME = 'files-store';
            function initDB() { return new Promise((resolve, reject) => { const request = indexedDB.open(DB_NAME, 1); request.onupgradeneeded = e => { const db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) { db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true }); } }; request.onsuccess = e => { db = e.target.result; resolve(db); }; request.onerror = e => reject('Database error: ' + e.target.errorCode); }); }
            function getStore(mode) { return db.transaction(STORE_NAME, mode).objectStore(STORE_NAME); }
            const dbActions = { add: (item) => new Promise((res, rej) => { const r = getStore('readwrite').add(item); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }), getAll: () => new Promise((res, rej) => { const r = getStore('readonly').getAll(); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }), update: (item) => new Promise((res, rej) => { const r = getStore('readwrite').put(item); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }), delete: (id) => new Promise((res, rej) => { const r = getStore('readwrite').delete(id); r.onsuccess = () => res(); r.onerror = () => rej(r.error); }), clear: () => new Promise((res, rej) => { const r = getStore('readwrite').clear(); r.onsuccess = () => res(); r.onerror = () => rej(r.error); }), };
            
            // --- DOM 元素获取 ---
            const docBody = document.body, docRoot = document.documentElement, itemsContainer = document.getElementById('items-container'), groupList = document.getElementById('group-list'), searchBox = document.getElementById('search-box'), addNoteBtn = document.getElementById('add-note-btn'), noteModalOverlay = document.getElementById('note-modal-overlay'), noteForm = document.getElementById('note-form'), modalTitle = document.getElementById('modal-title'), cancelBtn = document.getElementById('cancel-btn'), noteIdInput = document.getElementById('note-id'), noteContentInput = document.getElementById('note-content'), noteGroupInput = document.getElementById('note-group'), noteRemarkInput = document.getElementById('note-remark'), noteGroupDropdown = document.getElementById('note-group-dropdown'), uploadFileBtn = document.getElementById('upload-file-btn'), fileInput = document.getElementById('file-input'), fileModalOverlay = document.getElementById('file-modal-overlay'), fileForm = document.getElementById('file-form'), fileModalTitle = document.getElementById('file-modal-title'), fileIdInput = document.getElementById('file-id'), fileNameDisplay = document.getElementById('file-name-display'), fileGroupInput = document.getElementById('file-group'), fileRemarkInput = document.getElementById('file-remark'), fileGroupDropdown = document.getElementById('file-group-dropdown'), cancelFileBtn = document.getElementById('cancel-file-btn'), confirmModalOverlay = document.getElementById('confirm-modal-overlay'), confirmModalText = document.getElementById('confirm-modal-text'), confirmYesBtn = document.getElementById('confirm-yes'), confirmNoBtn = document.getElementById('confirm-no'), infoModalOverlay = document.getElementById('info-modal-overlay'), infoModalText = document.getElementById('info-modal-text'), infoOkBtn = document.getElementById('info-ok-btn'), importBtn = document.getElementById('import-btn'), exportBtn = document.getElementById('export-btn'), importFileInput = document.getElementById('import-file-input'), importOptionsModalOverlay = document.getElementById('import-options-modal-overlay'), importSelectFileBtn = document.getElementById('import-select-file-btn'), importOptionsCancelBtn = document.getElementById('import-options-cancel-btn'), hamburgerMenu = document.getElementById('hamburger-menu'), sidebar = document.getElementById('sidebar'), sidebarOverlay = document.getElementById('sidebar-overlay'), copyFeedback = document.getElementById('copy-feedback'), presetColorsContainer = document.getElementById('preset-colors'), customColorPicker = document.getElementById('custom-color-picker'), viewerModalOverlay = document.getElementById('viewer-modal-overlay'), viewerHeader = document.getElementById('viewer-header'), viewerFilename = document.getElementById('viewer-filename'), closeViewerBtn = document.getElementById('close-viewer-btn'), viewerContent = document.getElementById('viewer-content'), viewerPageIndicator = document.getElementById('viewer-page-indicator');

            // --- 数据与状态 ---
            let notes = [], files = [], groupOrder = [], currentFilterGroup = 'all', confirmCallback = null, tempFile = null, currentObjectUrl = null;
            let currentPdfDoc = null;
            let viewerScrollHandler = null;

            // --- 主题美化 ---
            const presetThemes = [ { name: '默认 · 宝蓝', hue: 215, sat: 50, light: 50, value: '#4069bf' }, { name: '草莓奶昔', hue: 345, sat: 80, light: 88, value: '#fcdbe4' }, { name: '奶油黄', hue: 55, sat: 75, light: 75, value: '#f2e6a4' }, { name: '薄荷马卡龙', hue: 150, sat: 55, light: 85, value: '#c7f2de' }, { name: '海盐冰淇淋', hue: 195, sat: 70, light: 82, value: '#bce6f7' }, { name: '香芋布丁', hue: 260, sat: 65, light: 88, value: '#e6dff9' }, { name: '蜜桃苏打', hue: 20, sat: 90, light: 80, value: '#fcd3c4' }, { name: '宝宝蓝', hue: 210, sat: 70, light: 80, value: '#b8d6f5' }, { name: '抹茶拿铁', hue: 95, sat: 35, light: 80, value: '#d5e6c7' }, { name: '焦糖饼干', hue: 30, sat: 50, light: 75, value: '#e6ccb3' }, ];
            const applyTheme = (h, s, l) => { docRoot.style.setProperty('--theme-hue', h); docRoot.style.setProperty('--theme-sat', `${s}%`); docRoot.style.setProperty('--theme-light', `${l}%`); localStorage.setItem('theme', JSON.stringify({ hue: h, sat: s, light: l })); };
            const loadTheme = () => { const t = JSON.parse(localStorage.getItem('theme')) || presetThemes[0]; applyTheme(t.hue, t.sat, t.light); presetColorsContainer.innerHTML = ''; presetThemes.forEach(theme => { const d = document.createElement('div'); d.className = 'preset-dot'; d.style.backgroundColor = theme.value; d.title = theme.name; d.addEventListener('click', () => applyTheme(theme.hue, theme.sat, theme.light)); presetColorsContainer.appendChild(d); }); };

            // --- 数据管理 ---
            const saveNotes = () => localStorage.setItem('notes-app-data', JSON.stringify(notes));
            const saveGroupOrder = () => localStorage.setItem('group-order-data', JSON.stringify(groupOrder));
            const getAllGroups = () => { const ng = notes.map(n => n.group?.trim()); const fg = files.map(f => f.group?.trim()); return [...new Set([...ng, ...fg].filter(g => g))]; };

            // --- 渲染函数 ---
            const renderGroups = () => {
                const allGroups = getAllGroups();
                groupOrder = groupOrder.filter(g => allGroups.includes(g));
                allGroups.forEach(g => { if (!groupOrder.includes(g)) groupOrder.push(g); });
                saveGroupOrder();

                groupList.innerHTML = '';
                const staticGroups = [ { key: 'all', text: '所有条目' }, { key: 'notes_only', text: '文案' }, { key: 'files_only', text: '文件' } ];
                staticGroups.forEach(g => { const li = document.createElement('li'); li.dataset.group = g.key; li.textContent = g.text; if (g.key === currentFilterGroup) li.classList.add('active'); groupList.appendChild(li); });
                if (groupOrder.length > 0) { const d = document.createElement('div'); d.className = 'divider'; groupList.appendChild(d); groupOrder.forEach(g => { const li = document.createElement('li'); li.dataset.group = g; li.textContent = g; li.draggable = true; li.classList.add('draggable'); if (g === currentFilterGroup) li.classList.add('active'); groupList.appendChild(li); }); }
            };
            const applyCollapsibleLogic = () => { const allContentDivs = itemsContainer.querySelectorAll('.note-content'); allContentDivs.forEach(div => { const computedStyle = getComputedStyle(div); const lineHeight = parseFloat(computedStyle.lineHeight); if (div.scrollHeight > (lineHeight * 5)) { div.classList.add('collapsible'); } }); };
            const renderItems = () => { const all = [...notes, ...files].sort((a, b) => b.id - a.id); const term = searchBox.value.trim().toLowerCase(); const filtered = all.filter(i => { const groupMatch = currentFilterGroup === 'all' || (currentFilterGroup === 'notes_only' && i.type === 'note') || (currentFilterGroup === 'files_only' && i.type === 'file') || i.group === currentFilterGroup; if (!groupMatch) return false; if (term === '') return true; if (i.type === 'note') { return (i.content?.toLowerCase().includes(term)) || (i.group?.toLowerCase().includes(term)) || (i.remark?.toLowerCase().includes(term)); } else { return (i.filename?.toLowerCase().includes(term)) || (i.group?.toLowerCase().includes(term)) || (i.remark?.toLowerCase().includes(term)); } }); itemsContainer.innerHTML = ''; if (filtered.length === 0) { itemsContainer.innerHTML = '<p style="color: var(--subtle-text-color); grid-column: 1 / -1; text-align: center; margin-top: 50px;">没有找到匹配的条目哦。</p>'; } else { filtered.forEach(i => itemsContainer.appendChild(i.type === 'note' ? createNoteCard(i, term) : createFileCard(i, term))); } applyCollapsibleLogic(); };
            const escapeHTML = (str) => { const p = document.createElement('p'); p.textContent = str; return p.innerHTML; };
            const highlightText = (text, term) => { const safeText = escapeHTML(text || ''); if (!term) return safeText; const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'); return safeText.replace(regex, match => `<mark class="highlight">${match}</mark>`); };
            function createNoteCard(note, term) { const c = document.createElement('div'); c.className = 'note-card'; c.dataset.id = note.id; c.dataset.type = 'note'; c.innerHTML = `<div class="note-content">${highlightText(note.content, term)}</div><div><div class="item-footer">${note.group ? `<span class="group">${highlightText(note.group || '', term)}</span>` : ''}<span>${highlightText(note.remark || '', term)}</span></div><div class="item-actions"><button class="copy-btn">复制</button><button class="edit-btn">编辑</button><button class="delete-btn">删除</button></div></div>`; return c; }
            function createFileCard(file, term) { const c = document.createElement('div'); c.className = 'file-card'; c.dataset.id = file.id; c.dataset.type = 'file'; const size = file.file ? `${(file.file.size / 1024).toFixed(2)} KB` : 'N/A'; c.innerHTML = `<div class="file-info"><span class="icon">📄</span><div class="file-details"><div class="filename">${highlightText(file.filename, term)}</div><div class="file-size">${size}</div></div></div><div><div class="item-footer">${file.group ? `<span class="group">${highlightText(file.group || '', term)}</span>` : ''}<span>${highlightText(file.remark || '', term)}</span></div><div class="item-actions"><button class="download-btn">下载</button><button class="edit-btn">编辑</button><button class="delete-btn">删除</button></div></div>`; return c; }
            const renderGroupDropdown = (input, dropdown) => { const f = input.value.toLowerCase(); const g = getAllGroups().filter(grp => grp.toLowerCase().includes(f)); dropdown.innerHTML = ''; if (g.length > 0) { [...new Set(g)].forEach(grp => { const i = document.createElement('div'); i.className = 'dropdown-item'; i.textContent = grp; i.addEventListener('mousedown', () => { input.value = grp; dropdown.classList.remove('visible'); }); dropdown.appendChild(i); }); dropdown.classList.add('visible'); } else { dropdown.classList.remove('visible'); } };
            
            // --- 事件处理 ---
            noteForm.addEventListener('submit', (e) => { e.preventDefault(); const id = noteIdInput.value; const content = noteContentInput.value.trim(); if (!content) { showInfoModal('内容不能为空哦！'); return; } const d = { type: 'note', content, group: noteGroupInput.value.trim(), remark: noteRemarkInput.value.trim() }; if (id) { const idx = notes.findIndex(n => n.id == id); if (idx > -1) notes[idx] = { ...notes[idx], ...d }; } else { notes.unshift({ id: Date.now(), ...d }); } saveNotes(); refreshUI(); hideNoteModal(); });
            fileForm.addEventListener('submit', async (e) => { e.preventDefault(); const filename = fileNameDisplay.value.trim(); if (!filename) { showInfoModal('文件名不能为空！'); return; } const id = parseInt(fileIdInput.value, 10); const d = { type: 'file', filename, group: fileGroupInput.value.trim(), remark: fileRemarkInput.value.trim() }; if (id) { const ef = files.find(f => f.id === id); await dbActions.update({ ...ef, ...d }); } else { if (!tempFile) { showInfoModal('文件不存在，请重新选择。'); return; } d.file = tempFile; await dbActions.add(d); } tempFile = null; await refreshUI(); hideFileModal(); });
            uploadFileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => { const f = e.target.files[0]; if (!f) return; tempFile = f; hideNoteModal(); showFileModal('add'); });
            itemsContainer.addEventListener('click', async (e) => { const card = e.target.closest('.note-card, .file-card'); if (!card) return; const id = parseInt(card.dataset.id, 10); const type = card.dataset.type; const targetIsActionButton = e.target.closest('.item-actions'); const targetIsCollapsible = e.target.closest('.note-content.collapsible'); if (targetIsCollapsible) { if (targetIsCollapsible.classList.contains('expanded')) { targetIsCollapsible.classList.remove('expanded'); targetIsCollapsible.style.maxHeight = null; } else { targetIsCollapsible.classList.add('expanded'); targetIsCollapsible.style.maxHeight = targetIsCollapsible.scrollHeight + 'px'; } return; } if (type === 'file' && !targetIsActionButton) { const file = files.find(f => f.id === id); if(file) showViewer(file); return; } if (targetIsActionButton) { const btn = e.target.closest('button'); if (!btn) return; if (btn.classList.contains('delete-btn')) { showConfirmModal(type === 'note' ? '确定要删除这条文案吗？' : '确定要删除这个文件吗？', async (c) => { if (c) { if (type === 'note') { notes = notes.filter(n => n.id !== id); saveNotes(); } else { await dbActions.delete(id); } await refreshUI(); } }, { danger: true, yesText: '删除' }); } else if (btn.classList.contains('edit-btn')) { if (type === 'note') { const n = notes.find(n => n.id === id); if (n) showNoteModal('edit', n); } else { const f = files.find(f => f.id === id); if (f) showFileModal('edit', f); } } else if (btn.classList.contains('copy-btn')) { const n = notes.find(n => n.id === id); if (n) copyToClipboard(n.content); } else if (btn.classList.contains('download-btn')) { const f = files.find(f => f.id === id); if (f?.file) { const url = URL.createObjectURL(f.file); const a = document.createElement('a'); a.href = url; a.download = f.filename; a.click(); URL.revokeObjectURL(url); } } } });
            
            // --- 导入/导出功能 ---
            const blobToBase64 = b => new Promise((res, rej) => { const r = new FileReader(); r.readAsDataURL(b); r.onload = () => res(r.result); r.onerror = e => rej(e); });
            const base64ToBlob = async (b64) => { const r = await fetch(b64); return await r.blob(); };
            exportBtn.addEventListener('click', async () => { if (notes.length === 0 && files.length === 0) { showInfoModal('没有数据可以导出。'); return; } showInfoModal('正在准备导出数据，请稍候...'); const filesForExport = []; for (const f of files) { if (f.file) { const b64 = await blobToBase64(f.file); filesForExport.push({ ...f, file: b64 }); } } const data = { notes, files: filesForExport, groupOrder, theme: JSON.parse(localStorage.getItem('theme')) || presetThemes[0] }; const str = JSON.stringify(data); const blob = new Blob([str], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); const d = new Date(); a.download = `数据备份_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.json`; a.href = url; a.click(); URL.revokeObjectURL(url); showInfoModal('数据已开始导出！'); closeSidebar(); });
            importBtn.addEventListener('click', () => showModal(importOptionsModalOverlay));
            importOptionsCancelBtn.addEventListener('click', () => hideModal(importOptionsModalOverlay));
            importSelectFileBtn.addEventListener('click', () => { hideModal(importOptionsModalOverlay); importFileInput.click(); });
            importFileInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (event) => { try { const parsedData = JSON.parse(event.target.result); let iN, iF, iGo, iT; if (Array.isArray(parsedData)) { iN = parsedData; iF = []; iGo = []; iT = null; } else { iN = parsedData.notes || []; iF = parsedData.files || []; iGo = parsedData.groupOrder || []; iT = parsedData.theme; } const mode = document.querySelector('input[name="import-mode"]:checked').value; const handleOverwrite = async () => { notes = iN; groupOrder = iGo; saveNotes(); saveGroupOrder(); await dbActions.clear(); for (const f of iF) { f.file = await base64ToBlob(f.file); delete f.id; await dbActions.add(f); } if (iT) { applyTheme(iT.hue, iT.sat, iT.light); loadTheme(); } await refreshUI(); showInfoModal('数据已成功覆盖！'); }; if (mode === 'overwrite') { showConfirmModal('此操作将覆盖所有文案和文件，确定吗？', (c) => { if (c) handleOverwrite(); }, { danger: true, yesText: '确定覆盖' }); } else { const existingNoteContents = new Set(notes.map(n => n.content)); const nonDuplicateNotes = iN.filter(n => !existingNoteContents.has(n.content)); const existingFilenames = new Set(files.map(f => f.filename)); const nonDuplicateFiles = iF.filter(f => !existingFilenames.has(f.filename)); const dupCount = (iN.length - nonDuplicateNotes.length) + (iF.length - nonDuplicateFiles.length); const handleAppend = async (addAll) => { const notesToAdd = addAll ? iN : nonDuplicateNotes; const filesToAdd = addAll ? iF : nonDuplicateFiles; notes.push(...notesToAdd); iGo.forEach(g => { if(!groupOrder.includes(g)) groupOrder.push(g) }); saveNotes(); saveGroupOrder(); for (const f of filesToAdd) { f.file = await base64ToBlob(f.file); delete f.id; await dbActions.add(f); } await refreshUI(); showInfoModal(`${notesToAdd.length + filesToAdd.length}个新项目已成功添加！`); }; if (dupCount > 0) { showConfirmModal(`发现 ${dupCount} 个重复项目。`, c => handleAppend(c), { yesText: '全部添加', noText: '跳过重复' }); } else { handleAppend(false); } } } catch (err) { showInfoModal('导入失败！请确保是正确的备份文件。'); console.error(err); } finally { e.target.value = ''; closeSidebar(); } }; reader.readAsText(file); });
            
            // --- 弹窗、侧边栏、预览等UI控制 ---
            const showModal = (o) => { o.classList.add('visible'); docBody.classList.add('modal-open'); };
            const hideModal = (o) => { o.classList.remove('visible'); docBody.classList.remove('modal-open'); };
            const showNoteModal = (mode = 'add', note = null) => { noteForm.reset(); modalTitle.textContent = mode === 'edit' ? '编辑文案' : '添加新文案'; noteIdInput.value = note?.id || ''; noteContentInput.value = note?.content || ''; noteGroupInput.value = note?.group || ''; noteRemarkInput.value = note?.remark || ''; showModal(noteModalOverlay); };
            const hideNoteModal = () => hideModal(noteModalOverlay);
            const showFileModal = (mode = 'add', file = null) => { fileForm.reset(); fileModalTitle.textContent = mode === 'edit' ? '编辑文件详情' : '文件详情'; fileIdInput.value = file?.id || ''; fileNameDisplay.value = file?.filename || tempFile?.name || '未知文件'; fileGroupInput.value = file?.group || ''; fileRemarkInput.value = file?.remark || ''; showModal(fileModalOverlay); };
            const hideFileModal = () => hideModal(fileModalOverlay);
            const showConfirmModal = (msg, cb, opt={}) => { confirmModalText.textContent = msg; confirmYesBtn.textContent = opt.yesText || '确定'; confirmNoBtn.textContent = opt.noText || '取消'; confirmCallback = cb; showModal(confirmModalOverlay); };
            const hideConfirmModal = () => hideModal(confirmModalOverlay);
            const showInfoModal = (msg) => { infoModalText.textContent = msg; showModal(infoModalOverlay); };
            const hideInfoModal = () => hideModal(infoModalOverlay);
            
            const showViewer = async (file) => {
                if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
                viewerFilename.textContent = file.filename;
                viewerContent.innerHTML = '';
                viewerPageIndicator.textContent = '';
                const type = file.file.type;
                const filename = file.filename.toLowerCase();
                currentObjectUrl = URL.createObjectURL(file.file);
                let element;

                if (type.startsWith('image/')) {
                    element = document.createElement('img');
                    element.src = currentObjectUrl;
                } else if (type.startsWith('video/')) {
                    element = document.createElement('video');
                    element.src = currentObjectUrl;
                    element.controls = true;
                } else if (type.startsWith('audio/')) {
                    element = document.createElement('audio');
                    element.src = currentObjectUrl;
                    element.controls = true;
                } else if (type === 'application/pdf') {
                    viewerContent.innerHTML = `<div class="loader"></div>`;
                    
                    const setupPdfViewer = async (pdfDoc) => {
                        currentPdfDoc = pdfDoc;
                        const totalPages = pdfDoc.numPages;
                        const pdfPageCanvases = [];
                        
                        viewerPageIndicator.textContent = `第 1 / ${totalPages} 页`;
                        viewerContent.innerHTML = '';
                        
                        viewerScrollHandler = () => {
                            const viewerRect = viewerContent.getBoundingClientRect();
                            let mostVisiblePage = 1;
                            let maxVisibleHeight = 0;

                            pdfPageCanvases.forEach((canvas, index) => {
                                const canvasRect = canvas.getBoundingClientRect();
                                const visibleTop = Math.max(viewerRect.top, canvasRect.top);
                                const visibleBottom = Math.min(viewerRect.bottom, canvasRect.bottom);
                                const visibleHeight = Math.max(0, visibleBottom - visibleTop);

                                if (visibleHeight > maxVisibleHeight) {
                                    maxVisibleHeight = visibleHeight;
                                    mostVisiblePage = index + 1;
                                }
                            });
                            viewerPageIndicator.textContent = `第 ${mostVisiblePage} / ${totalPages} 页`;
                        };
                        viewerContent.addEventListener('scroll', viewerScrollHandler);

                        for (let i = 1; i <= totalPages; i++) {
                            const page = await pdfDoc.getPage(i);
                            const pixelRatio = window.devicePixelRatio || 1;
                            const viewport = page.getViewport({ scale: pixelRatio * 1.5 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            const renderContext = { canvasContext: context, viewport: viewport };
                            await page.render(renderContext).promise;
                            viewerContent.appendChild(canvas);
                            pdfPageCanvases.push(canvas);
                        }
                    };
                    
                    pdfjsLib.getDocument(currentObjectUrl).promise.then(setupPdfViewer).catch(err => {
                        console.error('PDF.js error:', err);
                        viewerContent.innerHTML = `<div class="unsupported-preview"><p>无法预览此PDF文件。</p><a href="${currentObjectUrl}" download="${file.filename}" class="download-btn">下载文件</a></div>`;
                    });

                } else if (type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || filename.endsWith('.docx')) {
                    viewerContent.innerHTML = `<div class="loader"></div>`;
                    setTimeout(async () => {
                        try {
                            const arrayBuffer = await file.file.arrayBuffer();
                            const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                            const previewContainer = document.createElement('div');
                            previewContainer.className = 'docx-preview-container';
                            previewContainer.innerHTML = result.value;
                            viewerContent.innerHTML = '';
                            viewerContent.appendChild(previewContainer);

                            viewerScrollHandler = () => {
                                const { scrollTop, scrollHeight, clientHeight } = viewerContent;
                                if (clientHeight > 0) {
                                    const totalPages = Math.max(1, Math.ceil(scrollHeight / clientHeight));
                                    const isAtBottom = Math.abs(scrollHeight - scrollTop - clientHeight) < 1;
                                    let currentPage = Math.floor(scrollTop / clientHeight) + 1;
                                    if (isAtBottom) {
                                        currentPage = totalPages;
                                    }
                                    viewerPageIndicator.textContent = `第 ${currentPage} / ${totalPages} 页 (预估)`;
                                }
                            };
                            viewerContent.addEventListener('scroll', viewerScrollHandler);
                            viewerScrollHandler();

                        } catch (err) {
                            console.error('Mammoth.js error:', err);
                            viewerContent.innerHTML = `<div class="unsupported-preview"><p>无法预览此DOCX文件。</p><a href="${currentObjectUrl}" download="${file.filename}" class="download-btn">下载文件</a></div>`;
                        }
                    }, 50);
                } else if (type.startsWith('text/') || type === 'application/json') {
                    element = document.createElement('pre');
                    element.textContent = await file.file.text();
                } else {
                    viewerContent.innerHTML = `<div class="unsupported-preview"><p>无法预览此文件类型。</p><a href="${currentObjectUrl}" download="${file.filename}" class="download-btn">下载文件</a></div>`;
                }
                
                if (element) viewerContent.appendChild(element);
                showModal(viewerModalOverlay);
            };

            const hideViewer = () => {
                hideModal(viewerModalOverlay);
                viewerContent.innerHTML = '';
                if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
                currentObjectUrl = null;

                if (currentPdfDoc) {
                    currentPdfDoc.destroy();
                    currentPdfDoc = null;
                }
                
                if (viewerScrollHandler) {
                    viewerContent.removeEventListener('scroll', viewerScrollHandler);
                    viewerScrollHandler = null;
                }
            };
            cancelBtn.addEventListener('click', hideNoteModal); noteModalOverlay.addEventListener('click', e => { if (e.target === noteModalOverlay) hideNoteModal(); });
            cancelFileBtn.addEventListener('click', hideFileModal); fileModalOverlay.addEventListener('click', e => { if (e.target === fileModalOverlay) hideFileModal(); });
            confirmYesBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(true); hideConfirmModal(); }); confirmNoBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(false); hideConfirmModal(); });
            infoOkBtn.addEventListener('click', hideInfoModal); infoModalOverlay.addEventListener('click', e => { if (e.target === infoModalOverlay) hideInfoModal(); });
            closeViewerBtn.addEventListener('click', hideViewer);
            viewerModalOverlay.addEventListener('click', e => {
                if (e.target === viewerModalOverlay) {
                    hideViewer();
                }
            });
            const openSidebar = () => { sidebar.classList.add('open'); sidebarOverlay.classList.add('visible'); };
            const closeSidebar = () => { sidebar.classList.remove('open'); sidebarOverlay.classList.remove('visible'); };
            hamburgerMenu.addEventListener('click', openSidebar); sidebarOverlay.addEventListener('click', closeSidebar); addNoteBtn.addEventListener('click', () => showNoteModal('add'));
            groupList.addEventListener('click', (e) => { const li = e.target.closest('li'); if (li && li.dataset.group) { currentFilterGroup = li.dataset.group; refreshUI(); closeSidebar(); } });
            searchBox.addEventListener('input', renderItems);
            
            // --- 辅助与刷新函数 ---
            const refreshUI = async () => { files = await dbActions.getAll(); renderGroups(); renderItems(); };
            let copyTimeout; const copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(() => { clearTimeout(copyTimeout); copyFeedback.classList.add('show'); copyTimeout = setTimeout(() => copyFeedback.classList.remove('show'), 1500); }).catch(() => showInfoModal('复制失败！')); };
            
            // --- 拖拽排序 ---
            let draggedItem = null;
            groupList.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('draggable')) {
                    draggedItem = e.target;
                    const rect = e.target.getBoundingClientRect();
                    const offsetX = e.clientX - rect.left;
                    const offsetY = e.clientY - rect.top;
                    e.dataTransfer.setDragImage(e.target, offsetX, offsetY);
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });
            groupList.addEventListener('dragover', (e) => { e.preventDefault(); const afterElement = getDragAfterElement(groupList, e.clientY); const current = document.querySelector('.dragging'); if (afterElement == null) { groupList.appendChild(current); } else { groupList.insertBefore(current, afterElement); } });
            groupList.addEventListener('dragend', () => { if(draggedItem) draggedItem.classList.remove('dragging'); });
            groupList.addEventListener('drop', () => { const newOrder = [...groupList.querySelectorAll('.draggable')].map(li => li.dataset.group); groupOrder = newOrder; saveGroupOrder(); });
            function getDragAfterElement(container, y) { const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }

            // --- 初始化 ---
            const migrateData = () => { let nc = false; const n = JSON.parse(localStorage.getItem('notes-app-data')) || []; const m = n.map(note => { if (!note.type) { note.type = 'note'; nc = true; } return note; }); if (nc) { localStorage.setItem('notes-app-data', JSON.stringify(m)); } notes = m; groupOrder = JSON.parse(localStorage.getItem('group-order-data')) || []; };
            const setupGroupInput = (input, dropdown, toggle) => {
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (dropdown.classList.contains('visible')) {
                        dropdown.classList.remove('visible');
                    } else {
                        renderGroupDropdown(input, dropdown);
                    }
                });
                input.addEventListener('focus', () => renderGroupDropdown(input, dropdown));
                input.addEventListener('input', () => renderGroupDropdown(input, dropdown));
                document.addEventListener('click', (e) => { if (!input.parentElement.contains(e.target)) dropdown.classList.remove('visible'); });
            };
            setupGroupInput(noteGroupInput, noteGroupDropdown, noteForm.querySelector('.group-dropdown-toggle'));
            setupGroupInput(fileGroupInput, fileGroupDropdown, fileForm.querySelector('.group-dropdown-toggle'));

            loadTheme();
            await initDB();
            migrateData();
            await refreshUI();
        });
    </script>
</body>
</html>
