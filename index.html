<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文案与文件存放站</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;</script>
    <style>
        /* --- 全局与主题样式 --- */
        :root {
            /* 核心颜色变量 */
            --theme-hue: 215;
            --theme-sat: 50%;
            --theme-light: 50%;

            /* 派生颜色变量 */
            --primary-bg: hsl(var(--theme-hue), calc(var(--theme-sat) * 0.9), 95%);
            --sidebar-bg: hsl(var(--theme-hue), var(--theme-sat), 92%);
            --main-header-bg: #ffffff;
            --card-bg: #ffffff;
            --button-bg: hsl(var(--theme-hue), var(--theme-sat), var(--theme-light));
            --button-hover-bg: hsl(var(--theme-hue), var(--theme-sat), calc(var(--theme-light) - 7%));
            
            --theme-color-darker: hsl(var(--theme-hue), calc(var(--theme-sat) * 1.1), calc(var(--theme-light) * 0.7));

            --text-color: #333333;
            --subtle-text-color: #777777;
            --border-color: hsl(var(--theme-hue), calc(var(--theme-sat) * 0.7), 86%);
            --shadow-color: hsla(var(--theme-hue), 25%, 50%, 0.1);
            --highlight-bg: #fff176;
            --font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            --line-height: 1.6; /* 定义行高变量 */
        }

        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--text-color);
            line-height: var(--line-height);
            overflow-x: hidden;
            transition: background-color 0.3s;
        }
        body.modal-open { overflow: hidden; }

        /* --- 主布局 --- */
        .container { display: flex; height: 100vh; }

        .sidebar {
            width: 220px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            box-sizing: border-box;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 200;
            transform: translateX(-100%);
            transition: transform 0.35s ease-out, background-color 0.3s, border-color 0.3s;
            box-shadow: 2px 0 5px var(--shadow-color);
            user-select: none; /* 防止拖动时选中文本 */
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            flex-shrink: 0;
        }
        .sidebar-header h2 { margin: 0; font-size: 1.5em; color: var(--theme-color-darker); transition: color 0.3s; }
        .sidebar-actions { display: flex; gap: 10px; }
        .sidebar-actions button {
            background: none;
            border: 1px solid var(--theme-color-darker);
            color: var(--theme-color-darker);
            border-radius: 5px;
            padding: 3px 8px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.3s;
        }
        .sidebar-actions button:hover { background-color: var(--theme-color-darker); color: white; }

        #group-list { list-style-type: none; padding: 0; margin-top: 15px; flex-grow: 1; overflow-y: auto; }
        #group-list li {
            padding: 10px 15px;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s, opacity 0.2s, border 0.2s;
            text-align: left;
            overflow: hidden; /* 配合flex-1的ellipsis */
            display: flex; /* 新增: 为了分组计数 */
            justify-content: space-between; /* (F3) 修改: 保持两端对齐 (根据你的反馈) */
            align-items: center; /* 新增: 为了分组计数 */
        }
        /* 配合flex, 让文字溢出省略 */
        #group-list li > span:first-child {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        /* (F3) 修改: 分组计数的样式 */
        .group-count {
            font-size: 0.8em; /* (F3) 修改: 调小字体 */
            color: var(--subtle-text-color);
            font-weight: normal;
            margin-left: 6px; /* (F3) 修改: 调小间距 */
            /* (F3) 移除: background-color, padding, border-radius */
        }
        /* (F3) 修改: 移除 active 时的背景色 */
        #group-list li.active .group-count {
            color: white;
            opacity: 0.7; /* (F3) 修改: 调暗一点 */
        }
        
        #group-list li.draggable { cursor: grab; }
        #group-list li.draggable:active { cursor: grabbing; }
        #group-list li.active { background-color: var(--button-bg); color: white; font-weight: bold; }
        #group-list .divider { height: 1px; background-color: var(--border-color); margin: 8px 0; padding: 0; }
        #group-list .dragging { opacity: 0.4; }
        #group-list .drag-over { border-top: 2px solid var(--button-bg); }


        /* 主题美化模块 */
        .theme-customizer { flex-shrink: 0; padding-top: 15px; margin-top: 15px; border-top: 1px solid var(--border-color); }
        .theme-customizer h3 { font-size: 1em; margin: 0 0 10px 0; color: var(--subtle-text-color); }
        #preset-colors { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .preset-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .preset-dot:hover { transform: scale(1.1); }
        .preset-dot.active { border-color: var(--button-bg); }
        .custom-color-wrapper { display: flex; align-items: center; gap: 10px; }
        .custom-color-wrapper label { font-size: 0.9em; }
        #custom-color-picker { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 28px; height: 28px; background-color: transparent; border: none; cursor: pointer; padding: 0; }
        #custom-color-picker::-webkit-color-swatch { border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        #custom-color-picker::-moz-color-swatch { border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; width: 100%; }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); z-index: 199; opacity: 0; visibility: hidden; transition: opacity 0.35s ease-out, visibility 0.35s ease-out; }
        #sidebar-overlay.visible { opacity: 1; visibility: visible; }

        .main-header { padding: 15px 25px 15px 15px; background-color: var(--main-header-bg); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 4px var(--shadow-color); z-index: 10; display: flex; align-items: center; gap: 12px; }
        #hamburger-menu { font-size: 1.8em; cursor: pointer; color: var(--theme-color-darker); padding: 5px; margin-right: 3px; border-radius: 5px; transition: background-color 0.2s, color 0.3s; }

        /* --- (新) 多关键词搜索框 --- */
        .multi-search-wrapper {
            flex-grow: 1;
            padding: 7px 15px;
            font-size: 1em;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #fff;
            display: flex;
            flex-wrap: nowrap; /* (新) 修改: wrap -> nowrap (强制一行) */
            overflow-x: auto; /* (新) 新增: 允许横向滚动 */
            align-items: center;
            gap: 6px;
            cursor: text;
        }
        .multi-search-wrapper:focus-within {
            outline: none;
            border-color: var(--button-bg);
            box-shadow: 0 0 5px hsla(var(--theme-hue), var(--theme-sat), var(--theme-light), 0.5);
        }

        .keyword-tag {
            display: inline-flex;
            align-items: center;
            background-color: hsl(var(--theme-hue), var(--theme-sat), 90%);
            color: var(--theme-color-darker);
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 0.9em;
            font-weight: 500;
            white-space: nowrap;
        }
        .keyword-tag .remove-tag {
            display: inline-block;
            margin-left: 6px;
            padding: 0;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--theme-color-darker);
            font-size: 1.1em;
            line-height: 1;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .keyword-tag .remove-tag:hover {
            opacity: 1;
        }

        #search-input {
            border: none;
            outline: none;
            padding: 0;
            font-size: 1em;
            font-family: var(--font-family);
            background-color: transparent;
            flex-grow: 1;
            min-width: 100px; /* (新) 修改: 200px -> 100px, 保证在有tag时仍有输入空间 */
            line-height: 1.6;
        }
        /* --- 结束 多关键词搜索框 --- */

        /* 搜索筛选按钮 (F3) */
        #search-filter-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--subtle-text-color);
            font-size: 1em;
            padding: 7px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        #search-filter-btn:hover {
            background-color: #f0f0f0;
            border-color: var(--subtle-text-color);
        }
        #search-filter-btn.active {
            border-color: var(--button-bg);
            background-color: var(--primary-bg);
            color: var(--button-bg);
            font-weight: bold;
        }

        /* 搜索筛选弹窗 (F3) */
        #search-filter-modal {
            position: absolute;
            top: 75px; /* 调整到 .main-header 下方 */
            right: 25px;
            width: 250px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px var(--shadow-color);
            z-index: 101;
            display: none;
            padding: 15px;
            box-sizing: border-box;
        }
        #search-filter-modal.visible { display: block; }
        #search-filter-modal h3 { margin: 0 0 10px 0; font-size: 1.1em; color: var(--text-color); }
        #search-filter-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 5px;
            margin-bottom: 10px;
            background: var(--primary-bg);
        }
        #search-filter-list label {
            display: block;
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        #search-filter-list label:hover { background-color: #f0f0f0; }
        #search-filter-list input { margin-right: 8px; }
        .search-filter-actions { display: flex; gap: 10px; }
        .search-filter-actions button {
            flex: 1;
            padding: 6px 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #search-filter-apply {
            background-color: var(--button-bg);
            color: white;
            border-color: var(--button-bg);
        }
        #search-filter-apply:hover { background-color: var(--button-hover-bg); }
        #search-filter-clear { background-color: #f1f1f1; color: var(--subtle-text-color); }
        #search-filter-clear:hover { background-color: #e0e0e0; }


        #items-container { flex-grow: 1; overflow-y: auto; padding: 30px; padding-bottom: 120px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; align-content: start; }

        .note-card, .file-card { background-color: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px var(--shadow-color); display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--border-color); position: relative; }
        .note-card:hover, .file-card:hover { transform: translateY(-5px); box-shadow: 0 6px 12px hsla(var(--theme-hue), 20%, 50%, 0.15); }
        .file-card { cursor: pointer; }

        .note-content { white-space: pre-wrap; word-wrap: break-word; flex-grow: 1; margin-bottom: 15px; transition: max-height 0.35s ease-in-out; }
        .note-content.collapsible { max-height: calc(1em * var(--line-height) * 5); overflow: hidden; position: relative; cursor: pointer; }
        .note-content.collapsible:not(.expanded)::after { content: '... 点击展开'; position: absolute; bottom: 0; right: 0; background: linear-gradient(to right, transparent, var(--card-bg) 25%); padding: 0 0 2px 30px; color: var(--subtle-text-color); font-weight: bold; font-size: 0.9em; }
        
        .item-footer { border-top: 1px solid var(--border-color); padding-top: 10px; font-size: 0.9em; color: var(--subtle-text-color); }
        .item-footer .group { background-color: var(--primary-bg); padding: 3px 8px; border-radius: 4px; font-weight: bold; color: var(--theme-color-darker); margin-right: 10px; display: inline-block; transition: background-color 0.3s, color 0.3s; }

        /* (F2) 修改: 卡片底部动作栏 */
        .item-actions {
            margin-top: 10px;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            align-items: center; /* (F2) 修改: 垂直居中对齐 */
            flex-wrap: wrap;
            gap: 0 10px; /* 按钮间距 */
        }
        .item-actions button {
            background: none; border: none; cursor: pointer; padding: 5px; 
            margin-left: 0;
            font-size: 0.9em; color: var(--subtle-text-color); transition: color 0.2s; display: inline-flex; align-items: center; gap: 3px;
        }
        .item-actions button:hover { color: var(--button-bg); }
        .highlight { background-color: var(--highlight-bg); border-radius: 3px; padding: 0 2px; color: #333; }

        /* (F2) 时间戳样式 */
        .item-timestamps {
            font-size: 0.8em;
            color: var(--subtle-text-color);
            line-height: 1.4;
            margin-right: auto; /* 推到最左边 */
            text-align: left;
            /* (F1) 移除: padding-bottom: 5px; (真的移除了) */
        }
        .item-timestamps .timestamp {
            white-space: nowrap;
        }
        /* (新) 移除: .item-timestamps .timestamp.modified 样式 (不再需要) */


        .file-info { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-grow: 1; }
        .file-info .icon { font-size: 2.5em; color: var(--button-bg); }
        .file-details .filename { font-weight: bold; word-break: break-all; }
        .file-details .file-size { font-size: 0.8em; color: var(--subtle-text-color); }

        #add-note-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--button-bg); color: white; border: none; border-radius: 50%; font-size: 2em; line-height: 60px; text-align: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); transition: background-color 0.3s, transform 0.2s; z-index: 100; }
        #add-note-btn:hover { background-color: var(--button-hover-bg); transform: scale(1.1); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal { background-color: var(--primary-bg); padding: 30px 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25); width: 90%; max-width: 500px; transform: scale(0.9); transition: transform 0.3s, background-color 0.3s; }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal h3 { margin-top: 0; margin-bottom: 25px; font-size: 1.8em; color: var(--theme-color-darker); text-align: center; transition: color 0.3s;}
        .modal .form-group { margin-bottom: 20px; }
        .modal label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-color); }
        .modal input[type="text"], .modal textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); background-color: #fff; border-radius: 8px; font-size: 1em; font-family: var(--font-family); box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
        .modal input[type="text"]:focus, .modal textarea:focus { outline: none; border-color: var(--button-bg); box-shadow: 0 0 5px hsla(var(--theme-hue), var(--theme-sat), var(--theme-light), 0.5); }
        .modal textarea { min-height: 150px; resize: vertical; }
        .group-input-wrapper { position: relative; display: flex; align-items: center; }
        .group-input-wrapper input { padding-right: 35px !important; }
        .group-dropdown-toggle { position: absolute; right: 1px; top: 1px; bottom: 1px; width: 35px; border: none; background: transparent; color: var(--subtle-text-color); cursor: pointer; font-size: 0.8em; border-radius: 0 8px 8px 0; }
        .group-dropdown-toggle:hover { background-color: rgba(0,0,0,0.05); }

        .form-divider { text-align: center; border-bottom: 1px solid var(--border-color); line-height: 0.1em; margin: 25px 0; }
        .form-divider span { background: var(--primary-bg); padding: 0 10px; color: var(--subtle-text-color); font-size: 0.9em; transition: background-color 0.3s; }
        #upload-file-btn { width: 100%; padding: 12px; background-color: #f1f1f1; color: var(--subtle-text-color); border: 1px dashed var(--border-color); border-radius: 8px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        #upload-file-btn:hover { background-color: #e9e9e9; border-color: var(--button-bg); }

        .modal-buttons { display: flex; align-items: center; gap: 15px; margin-top: 25px; }
        .modal-buttons button { flex: 1; text-align: center; padding: 10px 15px; border-radius: 8px; border: 1px solid; font-size: 1em; font-weight: bold; cursor: pointer; transition: background-color 0.3s, color 0.2s, transform 0.1s, border-color 0.3s; }
        .modal-buttons button:active { transform: scale(0.98); }

        #save-note-btn, #info-ok-btn, #save-file-btn, #import-select-file-btn, #html-viewer-close-btn { background-color: var(--button-bg); color: white; border-color: var(--button-bg); }
        #save-note-btn:hover, #info-ok-btn:hover, #save-file-btn:hover, #import-select-file-btn:hover, #html-viewer-close-btn:hover { background-color: var(--button-hover-bg); border-color: var(--button-hover-bg); }
        #cancel-btn, #import-options-cancel-btn, #cancel-file-btn { background-color: #f1f1f1; color: var(--subtle-text-color); border-color: var(--border-color); }
        #cancel-btn:hover, #import-options-cancel-btn:hover, #cancel-file-btn:hover { background-color: #e0e0e0; }
        
        #confirm-yes { background-color: #e74c3c; color: white; border-color: transparent; }
        #confirm-yes:hover { background-color: #c0392b; }
        #confirm-no { background-color: #f1f1f1; color: var(--subtle-text-color); border-color: var(--border-color); }
        #confirm-no:hover { background-color: #e0e0e0; }
        
        .group-form-group { position: relative; }
        .group-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: white; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px var(--shadow-color); max-height: 160px; overflow-y: auto; z-index: 1001; }
        .group-dropdown.visible { display: block; }
        .dropdown-item { padding: 10px 12px; cursor: pointer; transition: background-color 0.2s; }
        .dropdown-item:hover { background-color: var(--primary-bg); }

        .copy-feedback { position: fixed; top: 20px; left: 50%; background-color: #28a745; color: white; padding: 10px 20px; border-radius: 8px; opacity: 0; transform: translate(-50%, -10px);  transition: opacity 0.3s ease-out, transform 0.3s ease-out; z-index: 2002; pointer-events: none; }
        .copy-feedback.show { opacity: 1; transform: translate(-50%, 0); }

        /* --- 文件预览窗口样式 (有修改) --- */
        #viewer-modal-overlay { z-index: 2000; background-color: rgba(0,0,0,0.8); }
        #viewer-header { position: absolute; top: 0; left: 0; right: 0; padding: 15px 20px; background-color: rgba(20,20,20,0.7); display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; }
        #viewer-filename { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #close-viewer-btn { font-size: 1.5em; cursor: pointer; padding: 5px; line-height: 1; }
        
        #viewer-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px 20px;
            background-color: rgba(20, 20, 20, 0.7);
            color: white;
            z-index: 10;
            text-align: center;
            font-size: 0.9em;
            pointer-events: none;
        }
        
        #viewer-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 80px 20px 60px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        #viewer-content img,
        #viewer-content video,
        #viewer-content audio,
        #viewer-content iframe {
            max-width: 100%;
            max-height: 100%;
            border: none;
            object-fit: contain;
        }
        #viewer-content canvas {
            max-width: 95%;
            height: auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #viewer-content canvas:not(:first-child) {
            margin-top: 20px;
        }
        
        #viewer-content pre { width: 100%; height: 100%; background-color: #1e1e1e; color: #d4d4d4; padding: 20px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; box-sizing: border-box; }
        .unsupported-preview { color: white; text-align: center; margin-top: 40px; }
        .unsupported-preview p { margin-bottom: 20px; }
        .unsupported-preview .download-btn { background-color: var(--button-bg); color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--button-bg);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 80px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .docx-preview-container {
            font-family: Georgia, 'Times New Roman', Times, serif;
            background-color: #ffffff;
            color: #000000;
            padding: 40px 50px;
            border-radius: 5px;
            max-width: 840px;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.7;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            margin: 0 auto 20px auto;
        }
        .docx-preview-container h1, .docx-preview-container h2, .docx-preview-container h3, .docx-preview-container h4, .docx-preview-container h5, .docx-preview-container h6 {
            font-family: 'Segoe UI', Arial, sans-serif;
            color: #222;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            line-height: 1.3;
        }
        .docx-preview-container h1 { font-size: 2em; border-bottom: 2px solid #eee; padding-bottom: 0.3em; }
        .docx-preview-container h2 { font-size: 1.6em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
        .docx-preview-container h3 { font-size: 1.3em; }
        .docx-preview-container h4 { font-size: 1.1em; color: #444; }
        .docx-preview-container p { margin-bottom: 1.2em; }
        .docx-preview-container p:last-child { margin-bottom: 0; }
        .docx-preview-container ul, .docx-preview-container ol { padding-left: 2em; margin-bottom: 1.2em; }
        .docx-preview-container li { margin-bottom: 0.5em; }
        .docx-preview-container a { color: #005a9c; text-decoration: underline; }
        .docx-preview-container a:hover { color: #003366; }
        .docx-preview-container table { border-collapse: collapse; width: 100%; margin-bottom: 1.5em; font-size: 0.95em; }
        .docx-preview-container td, .docx-preview-container th { border: 1px solid #cccccc; padding: 10px 12px; text-align: left; }
        .docx-preview-container th { background-color: #f3f3f3; font-weight: bold; }

        /* HTML 预览弹窗样式 (F4) */
#html-viewer-modal {
    max-width: 95vw; /* (新) 修改: 80vw -> 95vw，让弹窗更宽 */
    width: 800px;
    padding: 20px;   /* (新) 新增: 覆盖 .modal 的 30px 40px padding */
}
        #html-viewer-content {
            /* (F1) 移除: min-height: 400px; (真的移除了) */
            max-height: 70vh;
            overflow-y: auto;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0;
            line-height: var(--line-height);
            position: relative; /* (F1) 新增: 修正样式错位问题 */
        }
    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar"> <div class="sidebar-header"> <h2>分组</h2> <div class="sidebar-actions"> <button id="import-btn">导入</button> <button id="export-btn">导出</button> </div> </div> <input type="file" id="import-file-input" accept=".json" style="display: none;"> <ul id="group-list"></ul> <div class="theme-customizer"> <h3>主题颜色</h3> <div id="preset-colors"></div> <div class="custom-color-wrapper"> <label for="custom-color-picker">自定义</label> <input type="color" id="custom-color-picker" value="#4069bf"> </div> </div> </aside>
    <div id="sidebar-overlay"></div>
    <div class="container"> <main class="main-content"> <header class="main-header"> <span id="hamburger-menu">☰</span> <div class="multi-search-wrapper" id="multi-search-wrapper"> <input type="text" id="search-input" placeholder="搜索内容、文件名、分组、备注..."> </div> <button id="search-filter-btn" title="按分组筛选">▽</button> </header> <div id="items-container"></div> </main> </div>
    
    <div id="search-filter-modal" class="search-filter-modal">
        <h3>按分组筛选</h3>
        <div id="search-filter-list"></div>
        <div class="search-filter-actions">
            <button id="search-filter-clear">清除</button>
            <button id="search-filter-apply">应用</button>
        </div>
    </div>

    <button id="add-note-btn">+</button>
    <div class="modal-overlay" id="note-modal-overlay"> <div class="modal" id="note-modal"> <h3 id="modal-title">添加新文案</h3> <form id="note-form"> <input type="hidden" id="note-id"> <div class="form-group"> <label for="note-content">内容 (必填)</label> <textarea id="note-content" required></textarea> </div> <div class="form-group group-form-group"> <label for="note-group">分组</label> <div class="group-input-wrapper"><input type="text" id="note-group" placeholder="输入新分组" autocomplete="off"><button type="button" class="group-dropdown-toggle">▼</button></div> <div id="note-group-dropdown" class="group-dropdown"></div> </div> <div class="form-group"> <label for="note-remark">备注</label> <input type="text" id="note-remark" placeholder="例如：这是一个转盘"> </div> <div class="form-divider"><span>或</span></div> <div class="form-group"> <label>存放文件</label> <button type="button" id="upload-file-btn">点击选择文件</button> <input type="file" id="file-input" style="display: none;"> </div> <div class="modal-buttons"> <button type="button" id="cancel-btn">取消</button> <button type="submit" id="save-note-btn">保存</button> </div> </form> </div> </div>
    <div class="modal-overlay" id="file-modal-overlay"> <div class="modal" id="file-modal"> <h3 id="file-modal-title">文件详情</h3> <form id="file-form"> <input type="hidden" id="file-id"> <div class="form-group"> <label for="file-name-display">文件名</label> <input type="text" id="file-name-display" required> </div> <div class="form-group group-form-group"> <label for="file-group">分组</label> <div class="group-input-wrapper"><input type="text" id="file-group" placeholder="输入新分组" autocomplete="off"><button type="button" class="group-dropdown-toggle">▼</button></div> <div id="file-group-dropdown" class="group-dropdown"></div> </div> <div class="form-group"> <label for="file-remark">备注</label> <input type="text" id="file-remark" placeholder="添加备注..."> </div> <div class="modal-buttons"> <button type="button" id="cancel-file-btn">取消</button> <button type="submit" id="save-file-btn">保存文件</button> </div> </form> </div> </div>
    <div class="modal-overlay" id="import-options-modal-overlay"> <div class="modal" id="import-options-modal"> <h3>导入选项</h3> <form> <div class="form-group"> <div class="radio-group"> <label class="radio-label"> <input type="radio" name="import-mode" value="overwrite" checked> <strong>覆盖</strong> <small>覆盖当前所有文案与文件。</small> </label> <label class="radio-label"> <input type="radio" name="import-mode" value="append"> <strong>添加</strong> <small>在现有基础上，添加新内容。</small> </label> </div> </div> <div class="modal-buttons"> <button type="button" id="import-options-cancel-btn">取消</button> <button type="button" id="import-select-file-btn">选择文件</button> </div> </form> </div> </div>
    <div class="modal-overlay" id="confirm-modal-overlay"> <div class="modal" id="confirm-modal"> <div class="confirm-modal-content"> <p id="confirm-modal-text">确定要删除吗？</p> <div class="modal-buttons" id="confirm-modal-buttons"> <button id="confirm-no">取消</button> <button id="confirm-yes">确定</button> </div> </div> </div> </div>
    <div class="modal-overlay" id="info-modal-overlay"> <div class="modal" id="info-modal"> <div class="info-modal-content"> <p id="info-modal-text">这里是提示信息</p> <div class="modal-buttons"> <button id="info-ok-btn">好的</button> </div> </div> </div> </div>
    <div class="modal-overlay" id="viewer-modal-overlay"> <div id="viewer-header"> <span id="viewer-filename"></span> <span id="close-viewer-btn">&times;</span> </div> <div id="viewer-content"></div> <div id="viewer-footer"> <span id="viewer-page-indicator"></span> </div> </div>
    <div class="copy-feedback" id="copy-feedback">已复制！</div>

    <div class="modal-overlay" id="html-viewer-overlay">
        <div class="modal" id="html-viewer-modal">
            <h3>HTML 预览</h3>
            <div id="html-viewer-content"></div>
            <div class="modal-buttons">
                <button id="html-viewer-close-btn" style="flex: 0.5;">关闭</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- 0. (修改) 动态注入多选模式的 CSS 样式 ---
        const style = document.createElement('style');
        style.textContent = `
            /* 多选模式下的卡片样式 */
            body.selection-mode .item-actions, 
            body.selection-mode #add-note-btn { display: none !important; }
            
            body.selection-mode .note-card { cursor: pointer; transition: all 0.2s; position: relative; }
            
            /* (新) 文件卡片变灰且不可点击 */
            body.selection-mode .file-card { 
                opacity: 0.5; 
                filter: grayscale(100%); 
                pointer-events: none; /* 禁止鼠标事件 */
                cursor: not-allowed;
            }

            /* (新) 锁死汉堡菜单 */
            body.selection-mode #hamburger-menu {
                pointer-events: none;
                opacity: 0.3;
            }

            body.selection-mode .note-card::after {
                content: ''; position: absolute; top: 10px; right: 10px; width: 20px; height: 20px;
                border: 2px solid var(--border-color); border-radius: 50%; background: white; transition: all 0.2s;
            }
            body.selection-mode .note-card.selected { border-color: var(--button-bg); background-color: #f0f7ff; transform: scale(0.98); }
            body.selection-mode .note-card.selected::after {
                background-color: var(--button-bg); border-color: var(--button-bg);
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='14px' height='14px'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
                background-position: center; background-repeat: no-repeat;
            }
            /* 底部操作栏 */
            #selection-bar {
                position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card-bg);
                padding: 15px 20px; box-shadow: 0 -4px 12px rgba(0,0,0,0.15); z-index: 3000;
                display: flex; justify-content: space-between; align-items: center;
                transform: translateY(120%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-sizing: border-box;
            }
            #selection-bar.visible { transform: translateY(0); }
            .selection-info { font-weight: bold; color: var(--theme-color-darker); }
            .selection-actions { display: flex; gap: 10px; }
            .selection-actions button {
                padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color);
                background: white; cursor: pointer; font-size: 0.9em;
            }
            #sel-export-btn { background-color: var(--button-bg); color: white; border-color: var(--button-bg); }
        `;
        document.head.appendChild(style);

        // --- 1. 核心数据库设置 (IndexedDB) ---
        let db; 
        const DB_NAME = 'files-db'; 
        const STORE_NAME = 'files-store'; 

        function initDB() { 
            return new Promise((resolve, reject) => { 
                const request = indexedDB.open(DB_NAME, 1); 
                request.onupgradeneeded = e => { 
                    const db = e.target.result; 
                    if (!db.objectStoreNames.contains(STORE_NAME)) { 
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true }); 
                    } 
                }; 
                request.onsuccess = e => { db = e.target.result; resolve(db); }; 
                request.onerror = e => reject('Database error: ' + e.target.errorCode); 
            }); 
        }

        function getStore(mode) { return db.transaction(STORE_NAME, mode).objectStore(STORE_NAME); }
        const dbActions = { 
            add: (item) => new Promise((res, rej) => { const r = getStore('readwrite').add(item); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }), 
            getAll: () => new Promise((res, rej) => { const r = getStore('readonly').getAll(); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }), 
            update: (item) => new Promise((res, rej) => { const r = getStore('readwrite').put(item); r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error); }), 
            delete: (id) => new Promise((res, rej) => { const r = getStore('readwrite').delete(id); r.onsuccess = () => res(); r.onerror = () => rej(r.error); }), 
            clear: () => new Promise((res, rej) => { const r = getStore('readwrite').clear(); r.onsuccess = () => res(); r.onerror = () => rej(r.error); }), 
        };

        // --- 2. Base64 转换工具 ---
        const base64ToBlob = (dataURI) => {
            if(!dataURI) return null;
            const splitIndex = dataURI.indexOf(',');
            if (splitIndex === -1) return null;
            const base64 = dataURI.substring(splitIndex + 1);
            const byteString = atob(base64);
            const mimeString = dataURI.substring(5, splitIndex).split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: mimeString });
        };

        // --- 3. DOM 元素获取 ---
        const docBody = document.body, docRoot = document.documentElement, itemsContainer = document.getElementById('items-container'), groupList = document.getElementById('group-list');
        const addNoteBtn = document.getElementById('add-note-btn'), noteModalOverlay = document.getElementById('note-modal-overlay'), noteForm = document.getElementById('note-form'), modalTitle = document.getElementById('modal-title'), cancelBtn = document.getElementById('cancel-btn'), noteIdInput = document.getElementById('note-id'), noteContentInput = document.getElementById('note-content'), noteGroupInput = document.getElementById('note-group'), noteRemarkInput = document.getElementById('note-remark'), noteGroupDropdown = document.getElementById('note-group-dropdown');
        const uploadFileBtn = document.getElementById('upload-file-btn'), fileInput = document.getElementById('file-input'), fileModalOverlay = document.getElementById('file-modal-overlay'), fileForm = document.getElementById('file-form'), fileModalTitle = document.getElementById('file-modal-title'), fileIdInput = document.getElementById('file-id'), fileNameDisplay = document.getElementById('file-name-display'), fileGroupInput = document.getElementById('file-group'), fileRemarkInput = document.getElementById('file-remark'), fileGroupDropdown = document.getElementById('file-group-dropdown'), cancelFileBtn = document.getElementById('cancel-file-btn');
        const confirmModalOverlay = document.getElementById('confirm-modal-overlay'), confirmModalText = document.getElementById('confirm-modal-text'), confirmYesBtn = document.getElementById('confirm-yes'), confirmNoBtn = document.getElementById('confirm-no');
        const infoModalOverlay = document.getElementById('info-modal-overlay'), infoModalText = document.getElementById('info-modal-text'), infoOkBtn = document.getElementById('info-ok-btn');
        const importBtn = document.getElementById('import-btn'), exportBtn = document.getElementById('export-btn'), importFileInput = document.getElementById('import-file-input'), importOptionsModalOverlay = document.getElementById('import-options-modal-overlay'), importSelectFileBtn = document.getElementById('import-select-file-btn'), importOptionsCancelBtn = document.getElementById('import-options-cancel-btn');
        const hamburgerMenu = document.getElementById('hamburger-menu'), sidebar = document.getElementById('sidebar'), sidebarOverlay = document.getElementById('sidebar-overlay'), copyFeedback = document.getElementById('copy-feedback');
        const presetColorsContainer = document.getElementById('preset-colors'), customColorPicker = document.getElementById('custom-color-picker');
        const viewerModalOverlay = document.getElementById('viewer-modal-overlay'), viewerHeader = document.getElementById('viewer-header'), viewerFilename = document.getElementById('viewer-filename'), closeViewerBtn = document.getElementById('close-viewer-btn'), viewerContent = document.getElementById('viewer-content'), viewerPageIndicator = document.getElementById('viewer-page-indicator');
        const searchInput = document.getElementById('search-input'), searchWrapper = document.getElementById('multi-search-wrapper');
        const searchFilterBtn = document.getElementById('search-filter-btn'), searchFilterModal = document.getElementById('search-filter-modal'), searchFilterList = document.getElementById('search-filter-list'), searchFilterClear = document.getElementById('search-filter-clear'), searchFilterApply = document.getElementById('search-filter-apply');
        const htmlViewerOverlay = document.getElementById('html-viewer-overlay'), htmlViewerContent = document.getElementById('html-viewer-content'), htmlViewerCloseBtn = document.getElementById('html-viewer-close-btn');
        const sidebarActions = document.querySelector('.sidebar-actions');

        // --- 4. 数据与状态 ---
        let notes = [], files = [], groupOrder = [], currentFilterGroup = 'all', confirmCallback = null, tempFile = null, currentObjectUrl = null;
        let currentPdfDoc = null, viewerScrollHandler = null;
        let searchFilterGroups = [], searchKeywords = [];
        let isSelectionMode = false; // 新增：多选模式状态

        // --- 5. 主题美化 ---
        const presetThemes = [ { name: '默认 · 宝蓝', hue: 215, sat: 50, light: 50, value: '#4069bf' }, { name: '草莓奶昔', hue: 345, sat: 80, light: 88, value: '#fcdbe4' }, { name: '奶油黄', hue: 55, sat: 75, light: 75, value: '#f2e6a4' }, { name: '薄荷马卡龙', hue: 150, sat: 55, light: 85, value: '#c7f2de' }, { name: '海盐冰淇淋', hue: 195, sat: 70, light: 82, value: '#bce6f7' }, { name: '香芋布丁', hue: 260, sat: 65, light: 88, value: '#e6dff9' }, { name: '蜜桃苏打', hue: 20, sat: 90, light: 80, value: '#fcd3c4' }, { name: '宝宝蓝', hue: 210, sat: 70, light: 80, value: '#b8d6f5' }, { name: '抹茶拿铁', hue: 95, sat: 35, light: 80, value: '#d5e6c7' }, { name: '焦糖饼干', hue: 30, sat: 50, light: 75, value: '#e6ccb3' }, ];
        const applyTheme = (h, s, l) => { docRoot.style.setProperty('--theme-hue', h); docRoot.style.setProperty('--theme-sat', `${s}%`); docRoot.style.setProperty('--theme-light', `${l}%`); localStorage.setItem('theme', JSON.stringify({ hue: h, sat: s, light: l })); };
        const loadTheme = () => { const t = JSON.parse(localStorage.getItem('theme')) || presetThemes[0]; applyTheme(t.hue, t.sat, t.light); presetColorsContainer.innerHTML = ''; presetThemes.forEach(theme => { const d = document.createElement('div'); d.className = 'preset-dot'; d.style.backgroundColor = theme.value; d.title = theme.name; d.addEventListener('click', () => applyTheme(theme.hue, theme.sat, theme.light)); presetColorsContainer.appendChild(d); }); };

        // --- 6. 辅助函数 ---
        const formatTimestamp = (isoString) => { if (!isoString) return ''; try { const d = new Date(isoString); return d.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(/\//g, '-'); } catch(e) { return ''; } };
        const containsHTML = (str) => /<[a-z][\s\S]*>/i.test(str);
        const escapeHTML = (str) => { const p = document.createElement('p'); p.textContent = str; return p.innerHTML; };
        const saveGroupOrder = () => localStorage.setItem('group-order-data', JSON.stringify(groupOrder));
        const saveSearchFilter = () => localStorage.setItem('search-filter-groups', JSON.stringify(searchFilterGroups));
        const getAllGroups = () => { const ng = notes.map(n => n.group?.trim()); const fg = files.map(f => f.group?.trim()); return [...new Set([...ng, ...fg].filter(g => g))]; };

        // --- 7. 渲染函数 ---
        const renderGroups = () => {
            const allGroups = getAllGroups();
            groupOrder = groupOrder.filter(g => allGroups.includes(g));
            allGroups.forEach(g => { if (!groupOrder.includes(g)) groupOrder.push(g); });
            saveGroupOrder();

            const all = [...notes, ...files];
            const groupCounts = { 'all': all.length, 'notes_only': notes.length, 'files_only': files.length };
            all.forEach(item => { if (item.group) groupCounts[item.group] = (groupCounts[item.group] || 0) + 1; });

            groupList.innerHTML = '';
            const staticGroups = [ { key: 'all', text: '所有条目' }, { key: 'notes_only', text: '文案' }, { key: 'files_only', text: '文件' } ];
            staticGroups.forEach(g => {
                const li = document.createElement('li');
                li.dataset.group = g.key;
                li.innerHTML = `<span>${g.text}</span> <span class="group-count">${groupCounts[g.key] || 0}</span>`;
                if (g.key === currentFilterGroup) li.classList.add('active');
                groupList.appendChild(li);
            });
            if (groupOrder.length > 0) {
                groupList.appendChild(document.createElement('div')).className = 'divider';
                groupOrder.forEach(g => {
                    const li = document.createElement('li');
                    li.dataset.group = g;
                    li.innerHTML = `<span>${g}</span> <span class="group-count">${groupCounts[g] || 0}</span>`;
                    li.draggable = true; li.classList.add('draggable');
                    if (g === currentFilterGroup) li.classList.add('active');
                    groupList.appendChild(li);
                });
            }
        };

        const renderItems = () => {
            const all = [...notes, ...files].sort((a, b) => b.id - a.id);
            const currentTerm = searchInput.value.trim().toLowerCase();
            const allTerms = [...searchKeywords.map(k => k.toLowerCase())];
            if (currentTerm) allTerms.push(currentTerm);

            const filtered = all.filter(i => {
                const sidebarGroupMatch = currentFilterGroup === 'all' || (currentFilterGroup === 'notes_only' && i.type === 'note') || (currentFilterGroup === 'files_only' && i.type === 'file') || i.group === currentFilterGroup;
                if (!sidebarGroupMatch) return false;
                const searchGroupMatch = searchFilterGroups.length === 0 || (i.group && searchFilterGroups.includes(i.group));
                if (!searchGroupMatch) return false;
                if (allTerms.length === 0) return true;
                const searchableText = (i.type === 'note' ? [i.content, i.group, i.remark] : [i.filename, i.group, i.remark]).join(' ').toLowerCase();
                return allTerms.every(term => searchableText.includes(term));
            });

            itemsContainer.innerHTML = '';
            if (filtered.length === 0) {
                itemsContainer.innerHTML = '<p style="color: var(--subtle-text-color); grid-column: 1 / -1; text-align: center; margin-top: 50px;">没有找到匹配的条目哦。</p>';
            } else {
                filtered.forEach(i => itemsContainer.appendChild(i.type === 'note' ? createNoteCard(i, allTerms) : createFileCard(i, allTerms)));
            }
            const allContentDivs = itemsContainer.querySelectorAll('.note-content'); 
            allContentDivs.forEach(div => { if (div.scrollHeight > (parseFloat(getComputedStyle(div).lineHeight) * 5)) div.classList.add('collapsible'); });

            // 如果在选择模式下刷新了（例如筛选改变），需要退出选择模式或重新绑定
            if (isSelectionMode) exitSelectionMode();
        };

        const highlightText = (text, terms) => {
            const safeText = escapeHTML(text || '');
            if (!terms || terms.length === 0) return safeText;
            const escapedTerms = terms.filter(t => t.length > 0).map(term => term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
            if (escapedTerms.length === 0) return safeText;
            const regex = new RegExp(`(${escapedTerms.join('|')})`, 'gi');
            return safeText.replace(regex, match => `<mark class="highlight">${match}</mark>`);
        };

        function createNoteCard(note, terms) {
            const c = document.createElement('div');
            c.className = 'note-card'; c.dataset.id = note.id; c.dataset.type = 'note';
            const createdAt = note.createdAt ? formatTimestamp(note.createdAt) : formatTimestamp(new Date(note.id).toISOString());
            const hasHTML = containsHTML(note.content);
            c.innerHTML = `
                <div class="note-content">${highlightText(note.content, terms)}</div>
                <div>
                    <div class="item-footer">${note.group ? `<span class="group">${highlightText(note.group || '', terms)}</span>` : ''}<span>${highlightText(note.remark || '', terms)}</span></div>
                    <div class="item-actions">
                        <div class="item-timestamps">${createdAt ? `<div class="timestamp">${createdAt}</div>` : ''}</div>
                        ${hasHTML ? `<button class="preview-btn" title="预览HTML">预览</button>` : ''} <button class="copy-btn">复制</button> <button class="edit-btn">编辑</button> <button class="delete-btn">删除</button>
                    </div>
                </div>`;
            return c;
        }

        function createFileCard(file, terms) {
            const c = document.createElement('div');
            c.className = 'file-card'; c.dataset.id = file.id; c.dataset.type = 'file';
            const size = file.file ? `${(file.file.size / 1024).toFixed(2)} KB` : 'N/A';
            const createdAt = file.createdAt ? formatTimestamp(file.createdAt) : '';
            c.innerHTML = `
                <div class="file-info"><span class="icon">📄</span><div class="file-details"><div class="filename">${highlightText(file.filename, terms)}</div><div class="file-size">${size}</div></div></div>
                <div>
                    <div class="item-footer">${file.group ? `<span class="group">${highlightText(file.group || '', terms)}</span>` : ''}<span>${highlightText(file.remark || '', terms)}</span></div>
                    <div class="item-actions">
                        <div class="item-timestamps">${createdAt ? `<div class="timestamp">${createdAt}</div>` : ''}</div>
                        <button class="download-btn">下载</button> <button class="edit-btn">编辑</button> <button class="delete-btn">删除</button>
                    </div>
                </div>`;
            return c;
        }

        // --- 8. 事件处理 ---
        const refreshUI = async () => {
            const allItems = await dbActions.getAll();
            files = allItems.filter(i => i.type === 'file');
            notes = allItems.filter(i => i.type === 'note'); 
            renderGroups();
            renderItems();
        };

        noteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = noteIdInput.value;
            const content = noteContentInput.value.trim();
            if (!content) { showInfoModal('内容不能为空哦！'); return; }
            const d = { type: 'note', content, group: noteGroupInput.value.trim(), remark: noteRemarkInput.value.trim() };
            try {
                if (id) {
                    const existing = notes.find(n => n.id == id);
                    if (existing) await dbActions.update({ ...existing, ...d });
                } else {
                    const newNote = { createdAt: new Date().toISOString(), ...d }; 
                    await dbActions.add(newNote);
                }
                await refreshUI();
                hideNoteModal();
            } catch(err) { console.error(err); showInfoModal('保存失败：数据库错误'); }
        });

        fileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const filename = fileNameDisplay.value.trim();
            if (!filename) { showInfoModal('文件名不能为空！'); return; }
            const id = parseInt(fileIdInput.value, 10);
            const d = { type: 'file', filename, group: fileGroupInput.value.trim(), remark: fileRemarkInput.value.trim() };
            try {
                if (id) {
                    const ef = files.find(f => f.id === id);
                    await dbActions.update({ ...ef, ...d });
                } else {
                    if (!tempFile) { showInfoModal('文件不存在，请重新选择。'); return; }
                    d.file = tempFile;
                    d.createdAt = new Date().toISOString();
                    await dbActions.add(d);
                }
                tempFile = null;
                await refreshUI();
                hideFileModal();
            } catch (err) { console.error(err); showInfoModal('文件保存失败'); }
        });

        itemsContainer.addEventListener('click', async (e) => {
            const card = e.target.closest('.note-card, .file-card');
            if (!card) return;

            // --- (新增) 多选模式拦截 ---
            if (isSelectionMode) {
                // (新) 禁止选中文件
                if (card.dataset.type === 'file') return;

                card.classList.toggle('selected');
                updateSelectionCount();
                return; // 阻止后续逻辑（如预览、编辑）
            }
            // ---------------------------

            const id = parseInt(card.dataset.id, 10);
            const type = card.dataset.type;
            const targetIsActionButton = e.target.closest('.item-actions');
            const targetIsCollapsible = e.target.closest('.note-content.collapsible');
            
            if (targetIsCollapsible) {
                targetIsCollapsible.classList.toggle('expanded');
                targetIsCollapsible.style.maxHeight = targetIsCollapsible.classList.contains('expanded') ? targetIsCollapsible.scrollHeight + 'px' : null;
                return;
            }
            if (type === 'file' && !targetIsActionButton) {
                const file = files.find(f => f.id === id);
                if(file) showViewer(file);
                return;
            }
            if (targetIsActionButton) {
                const btn = e.target.closest('button');
                if (!btn) return;
                if (btn.classList.contains('delete-btn')) {
                    showConfirmModal(type === 'note' ? '确定要删除这条文案吗？' : '确定要删除这个文件吗？', async (c) => {
                        if (c) { await dbActions.delete(id); await refreshUI(); }
                    }, { danger: true, yesText: '删除' });
                } else if (btn.classList.contains('edit-btn')) {
                    if (type === 'note') {
                        const n = notes.find(n => n.id === id);
                        if (n) showNoteModal('edit', n);
                    } else {
                        const f = files.find(f => f.id === id);
                        if (f) showFileModal('edit', f);
                    }
                } else if (btn.classList.contains('copy-btn')) {
                    const n = notes.find(n => n.id === id);
                    if (n) copyToClipboard(n.content);
                } else if (btn.classList.contains('download-btn')) {
                    const f = files.find(f => f.id === id);
                    if (f?.file) {
                        const url = URL.createObjectURL(f.file);
                        const a = document.createElement('a'); a.href = url; a.download = f.filename; a.click(); URL.revokeObjectURL(url);
                    }
                } else if (btn.classList.contains('preview-btn')) {
                    const n = notes.find(n => n.id === id);
                    if (n) showHtmlViewer(n.content);
                }
            }
        });

        // --- 9. 导入逻辑 ---
        importBtn.addEventListener('click', () => showModal(importOptionsModalOverlay));
        importOptionsCancelBtn.addEventListener('click', () => hideModal(importOptionsModalOverlay));
        importSelectFileBtn.addEventListener('click', () => { hideModal(importOptionsModalOverlay); importFileInput.click(); });

        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) { e.target.value = ''; return; }
            showInfoModal('正在处理...');

            const reader = new FileReader();
            reader.onload = async (event) => {
                hideInfoModal();
                try {
                    const parsedData = JSON.parse(event.target.result);
                    let iN, iF, iGo, iT;
                    if (Array.isArray(parsedData)) { iN = parsedData; iF = []; iGo = []; iT = null; } 
                    else { iN = parsedData.notes || []; iF = parsedData.files || []; iGo = parsedData.groupOrder || []; iT = parsedData.theme; }
                    
                    const mode = document.querySelector('input[name="import-mode"]:checked').value;

                    const processImport = async (merge) => {
                        showInfoModal('正在写入数据库，请稍候...');
                        try {
                            let notesAdded = 0, notesSkipped = 0;
                            let filesAdded = 0, filesSkipped = 0;

                            if (mode === 'overwrite') {
                                await dbActions.clear();
                                groupOrder = iGo;
                                notesAdded = iN.length;
                            } else {
                                const currentContent = new Set(notes.map(n => n.content));
                                const initialLen = iN.length;
                                iN = iN.filter(n => !currentContent.has(n.content));
                                notesAdded = iN.length;
                                notesSkipped = initialLen - notesAdded;
                                iGo.forEach(g => { if (!groupOrder.includes(g)) groupOrder.push(g); });
                            }
                            saveGroupOrder();

                            for (const n of iN) {
                                const noteObj = { ...n, type: 'note' };
                                delete noteObj.id; 
                                if(!noteObj.createdAt) noteObj.createdAt = new Date().toISOString();
                                await dbActions.add(noteObj);
                            }

                            for (const f of iF) {
                                if (mode === 'append' && !merge) {
                                    const exists = files.some(existing => existing.filename === f.filename);
                                    if (exists) { filesSkipped++; continue; }
                                }
                                if (f.file && typeof f.file === 'string') {
                                    const blob = base64ToBlob(f.file);
                                    if (blob) {
                                        f.file = blob;
                                        delete f.id;
                                        await dbActions.add(f);
                                        filesAdded++;
                                    }
                                }
                            }

                            if (iT && mode === 'overwrite') {
                                applyTheme(iT.hue, iT.sat, iT.light);
                                loadTheme();
                            }

                            await refreshUI();
                            hideModal(importOptionsModalOverlay);
                            closeSidebar();
                            hideInfoModal();
                            
                            let resultHTML = '';
                            if (mode === 'overwrite') {
                                resultHTML = `
                                    <div style="text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 1.1em;">导入已完成 (覆盖模式)</div>
                                    <div style="margin-bottom: 5px;"><strong>文案数据</strong></div>
                                    <div style="padding-left: 10px; margin-bottom: 10px; color: var(--subtle-text-color);">
                                        共恢复：${notesAdded} 条
                                    </div>
                                    <div style="margin-bottom: 5px;"><strong>文件数据</strong></div>
                                    <div style="padding-left: 10px; color: var(--subtle-text-color);">
                                        共恢复：${filesAdded} 个
                                    </div>
                                `;
                            } else {
                                resultHTML = `
                                    <div style="text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 1.1em;">导入已完成 (添加模式)</div>
                                    <div style="margin-bottom: 5px;"><strong>文案部分</strong></div>
                                    <div style="padding-left: 10px; margin-bottom: 15px; color: var(--subtle-text-color);">
                                        成功新增：${notesAdded} 条<br>
                                        跳过重复：${notesSkipped} 条
                                    </div>
                                    <div style="margin-bottom: 5px;"><strong>文件部分</strong></div>
                                    <div style="padding-left: 10px; color: var(--subtle-text-color);">
                                        成功新增：${filesAdded} 个<br>
                                        跳过重复：${filesSkipped} 个
                                    </div>
                                `;
                            }
                            showInfoModal(resultHTML);

                        } catch (err) {
                            console.error(err);
                            hideInfoModal();
                            showInfoModal('写入出错：' + err.message);
                        }
                    };

                    if (mode === 'overwrite') {
                        showConfirmModal('此操作将覆盖所有数据，确定吗？', async (c) => {
                            if (c) await processImport(true);
                            else e.target.value = '';
                        }, { danger: true, yesText: '确定覆盖' });
                    } else {
                        await processImport(false);
                    }
                } catch (err) {
                    hideInfoModal();
                    showInfoModal('导入失败！文件可能损坏。');
                } finally { e.target.value = ''; }
            };
            reader.readAsText(file);
        });

        // --- 10. 导出逻辑 ---
        const blobToBase64 = b => new Promise((res, rej) => { const r = new FileReader(); r.readAsDataURL(b); r.onload = () => res(r.result); r.onerror = e => rej(e); });
        exportBtn.addEventListener('click', async () => { 
            if (notes.length === 0 && files.length === 0) { showInfoModal('没有数据可以导出。'); return; } 
            showInfoModal('正在打包数据，请耐心等待...'); 
            const filesForExport = []; 
            for (const f of files) { 
                if (f.file) { 
                    const b64 = await blobToBase64(f.file); 
                    filesForExport.push({ ...f, file: b64 }); 
                } 
            } 
            const data = { notes, files: filesForExport, groupOrder, theme: JSON.parse(localStorage.getItem('theme')) || presetThemes[0] }; 
            const str = JSON.stringify(data); 
            const blob = new Blob([str], { type: 'application/json' }); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            const d = new Date(); 
            a.download = `数据备份_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.json`; 
            a.href = url; a.click(); URL.revokeObjectURL(url); 
            hideInfoModal();
            closeSidebar(); 
        });

        // --- 11. UI 交互 ---
        const showModal = (o) => { o.classList.add('visible'); docBody.classList.add('modal-open'); };
        const hideModal = (o) => { o.classList.remove('visible'); docBody.classList.remove('modal-open'); };
        const showNoteModal = (mode = 'add', note = null) => { noteForm.reset(); modalTitle.textContent = mode === 'edit' ? '编辑文案' : '添加新文案'; noteIdInput.value = note?.id || ''; noteContentInput.value = note?.content || ''; noteGroupInput.value = note?.group || ''; noteRemarkInput.value = note?.remark || ''; showModal(noteModalOverlay); };
        const hideNoteModal = () => hideModal(noteModalOverlay);
        const showFileModal = (mode = 'add', file = null) => { fileForm.reset(); fileModalTitle.textContent = mode === 'edit' ? '编辑文件详情' : '文件详情'; fileIdInput.value = file?.id || ''; fileNameDisplay.value = file?.filename || tempFile?.name || '未知文件'; fileGroupInput.value = file?.group || ''; fileRemarkInput.value = file?.remark || ''; showModal(fileModalOverlay); };
        const hideFileModal = () => hideModal(fileModalOverlay);
        const showConfirmModal = (msg, cb, opt={}) => { confirmModalText.textContent = msg; confirmYesBtn.textContent = opt.yesText || '确定'; confirmNoBtn.textContent = opt.noText || '取消'; confirmCallback = cb; showModal(confirmModalOverlay); };
        const hideConfirmModal = () => hideModal(confirmModalOverlay);
        
        const showInfoModal = (msg) => { 
            if (msg.includes('<')) {
                infoModalText.innerHTML = msg;
                infoModalText.style.textAlign = 'left';
            } else {
                infoModalText.textContent = msg;
                infoModalText.style.textAlign = 'center';
            }
            infoModalText.style.lineHeight = '1.8'; 
            showModal(infoModalOverlay); 
        };
        const hideInfoModal = () => hideModal(infoModalOverlay);
        
        const showHtmlViewer = (htmlContent) => {
            const iframe = document.createElement('iframe'); iframe.style.width = '100%'; iframe.style.border = 'none'; iframe.style.display = 'block'; iframe.style.height = '65vh';
            htmlViewerContent.innerHTML = ''; htmlViewerContent.appendChild(iframe);
            try { const doc = iframe.contentWindow.document; doc.open(); doc.write(htmlContent); doc.close(); } catch (e) { htmlViewerContent.innerHTML = '<p>预览加载失败。</p>'; return; }
            setTimeout(() => { try { const body = iframe.contentWindow.document.body; const html = iframe.contentWindow.document.documentElement; body.style.margin = '0'; const height = Math.max( body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight ); iframe.style.height = (height + 2) + 'px'; } catch (e) { iframe.style.height = '65vh'; } }, 100);
            showModal(htmlViewerOverlay);
        };
        const hideHtmlViewer = () => { hideModal(htmlViewerOverlay); const iframe = htmlViewerContent.querySelector('iframe'); if (iframe) iframe.src = 'about:blank'; htmlViewerContent.innerHTML = ''; };
        htmlViewerCloseBtn.addEventListener('click', hideHtmlViewer); htmlViewerOverlay.addEventListener('click', e => { if (e.target === htmlViewerOverlay) hideHtmlViewer(); });

        const updateSearchFilterBtnState = () => { if (searchFilterGroups.length > 0) { searchFilterBtn.classList.add('active'); searchFilterBtn.textContent = `▽ (${searchFilterGroups.length})`; } else { searchFilterBtn.classList.remove('active'); searchFilterBtn.textContent = '▽'; } };
        const showSearchFilterModal = () => { const allGroups = getAllGroups(); searchFilterList.innerHTML = allGroups.length === 0 ? '<p style="color: var(--subtle-text-color); padding: 10px; text-align: center;">暂无分组</p>' : allGroups.map(g => `<label><input type="checkbox" value="${escapeHTML(g)}" ${searchFilterGroups.includes(g) ? 'checked' : ''}> ${escapeHTML(g)}</label>`).join(''); searchFilterModal.classList.add('visible'); };
        const hideSearchFilterModal = () => searchFilterModal.classList.remove('visible');
        searchFilterBtn.addEventListener('click', (e) => { e.stopPropagation(); searchFilterModal.classList.contains('visible') ? hideSearchFilterModal() : showSearchFilterModal(); });
        searchFilterApply.addEventListener('click', () => { searchFilterGroups = [...searchFilterList.querySelectorAll('input:checked')].map(input => input.value); saveSearchFilter(); updateSearchFilterBtnState(); renderItems(); hideSearchFilterModal(); });
        searchFilterClear.addEventListener('click', () => { searchFilterGroups = []; saveSearchFilter(); updateSearchFilterBtnState(); renderItems(); hideSearchFilterModal(); });
        document.addEventListener('click', (e) => { if (!searchFilterModal.contains(e.target) && e.target !== searchFilterBtn) hideSearchFilterModal(); });

        // 🌟 核心修复：App/WebView 环境下 PDF 预览 (Data传输 + XHR Fallback)
        const showViewer = async (file) => {
            if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
            viewerFilename.textContent = file.filename; viewerContent.innerHTML = ''; viewerPageIndicator.textContent = '';
            const type = file.file.type; const filename = file.filename.toLowerCase(); currentObjectUrl = URL.createObjectURL(file.file); let element;
            if (type.startsWith('image/')) { element = document.createElement('img'); element.src = currentObjectUrl; }
            else if (type.startsWith('video/')) { element = document.createElement('video'); element.src = currentObjectUrl; element.controls = true; }
            else if (type.startsWith('audio/')) { element = document.createElement('audio'); element.src = currentObjectUrl; element.controls = true; }
            else if (type === 'application/pdf') {
                viewerContent.innerHTML = `<div class="loader"></div>`;
                
                // 1. 尝试将 PDF 内容读取为 ArrayBuffer (Data传输)，这能绕过 "Blob XHR" 错误
                let pdfData = null;
                try {
                    pdfData = await file.file.arrayBuffer();
                } catch(e) { console.error("ArrayBuffer read failed", e); }

                const workerUrl = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
                // 默认策略：标准模式
                pdfjsLib.GlobalWorkerOptions.workerSrc = workerUrl;

                const setupPdfViewer = async (pdfDoc) => {
                    currentPdfDoc = pdfDoc; const totalPages = pdfDoc.numPages; const pdfPageCanvases = [];
                    viewerPageIndicator.textContent = `第 1 / ${totalPages} 页`; viewerContent.innerHTML = '';
                    viewerScrollHandler = () => { const viewerRect = viewerContent.getBoundingClientRect(); let mostVisiblePage = 1, maxVisibleHeight = 0; pdfPageCanvases.forEach((canvas, index) => { const canvasRect = canvas.getBoundingClientRect(); const visibleHeight = Math.max(0, Math.min(viewerRect.bottom, canvasRect.bottom) - Math.max(viewerRect.top, canvasRect.top)); if (visibleHeight > maxVisibleHeight) { maxVisibleHeight = visibleHeight; mostVisiblePage = index + 1; } }); viewerPageIndicator.textContent = `第 ${mostVisiblePage} / ${totalPages} 页`; };
                    viewerContent.addEventListener('scroll', viewerScrollHandler);
                    for (let i = 1; i <= totalPages; i++) { 
                        const page = await pdfDoc.getPage(i); 
                        const pixelRatio = window.devicePixelRatio || 1;
                        const viewport = page.getViewport({ scale: pixelRatio * 1.5 }); 
                        const canvas = document.createElement('canvas'); const context = canvas.getContext('2d'); canvas.height = viewport.height; canvas.width = viewport.width; 
                        await page.render({ canvasContext: context, viewport: viewport }).promise; 
                        viewerContent.appendChild(canvas); pdfPageCanvases.push(canvas); 
                    }
                };

                const loadPdf = async () => {
                    // 🌟 关键点：优先传递数据 (data)，而不是 URL
                    const source = pdfData ? { data: pdfData } : currentObjectUrl;

                    try {
                        return await pdfjsLib.getDocument(source).promise;
                    } catch (firstErr) {
                        console.warn('标准加载失败，尝试 XHR Worker 模式...', firstErr);
                        try {
                            const workerBlob = await new Promise((resolve, reject) => {
                                const xhr = new XMLHttpRequest();
                                xhr.open('GET', workerUrl, true);
                                xhr.responseType = 'blob';
                                xhr.onload = () => {
                                    if (xhr.status === 200 || xhr.status === 0) resolve(xhr.response);
                                    else reject(new Error('XHR status: ' + xhr.status));
                                };
                                xhr.onerror = () => reject(new Error('XHR Network Error'));
                                xhr.send();
                            });
                            
                            const reader = new FileReader();
                            const workerText = await new Promise((res, rej) => {
                                reader.onload = () => res(reader.result);
                                reader.onerror = rej;
                                reader.readAsText(workerBlob);
                            });
                            
                            const finalBlob = new Blob([workerText], { type: 'application/javascript' });
                            pdfjsLib.GlobalWorkerOptions.workerSrc = URL.createObjectURL(finalBlob);
                            return await pdfjsLib.getDocument(source).promise;
                            
                        } catch(secondErr) {
                             throw new Error('无法加载PDF引擎。请检查App联网权限。\n' + secondErr.message);
                        }
                    }
                };

                loadPdf().then(setupPdfViewer).catch((err) => {
                     console.error(err);
                     viewerContent.innerHTML = `<div class="unsupported-preview"><p>${err.message}</p><a href="${currentObjectUrl}" download="${file.filename}" class="download-btn">下载文件</a></div>`;
                });

            } else if (type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || filename.endsWith('.docx')) {
                viewerContent.innerHTML = `<div class="loader"></div>`;
                setTimeout(async () => { try { const arrayBuffer = await file.file.arrayBuffer(); const result = await mammoth.convertToHtml({ arrayBuffer }); const div = document.createElement('div'); div.className = 'docx-preview-container'; div.innerHTML = result.value; viewerContent.innerHTML = ''; viewerContent.appendChild(div); } catch (err) { viewerContent.innerHTML = `<div class="unsupported-preview"><p>无法预览。</p><a href="${currentObjectUrl}" download="${file.filename}" class="download-btn">下载文件</a></div>`; } }, 50);
            } else if (type.startsWith('text/') || type === 'application/json') { element = document.createElement('pre'); element.textContent = await file.file.text(); }
            else { viewerContent.innerHTML = `<div class="unsupported-preview"><p>无法预览。</p><a href="${currentObjectUrl}" download="${file.filename}" class="download-btn">下载文件</a></div>`; }
            if (element) viewerContent.appendChild(element); showModal(viewerModalOverlay);
        };
        const hideViewer = () => { hideModal(viewerModalOverlay); viewerContent.innerHTML = ''; if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl); currentObjectUrl = null; if (currentPdfDoc) { currentPdfDoc.destroy(); currentPdfDoc = null; } if (viewerScrollHandler) { viewerContent.removeEventListener('scroll', viewerScrollHandler); viewerScrollHandler = null; } };

        // 其他UI绑定
        uploadFileBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => { const f = e.target.files[0]; if (!f) return; tempFile = f; hideNoteModal(); showFileModal('add'); });
        cancelBtn.addEventListener('click', hideNoteModal); noteModalOverlay.addEventListener('click', e => { if (e.target === noteModalOverlay) hideNoteModal(); });
        cancelFileBtn.addEventListener('click', hideFileModal); fileModalOverlay.addEventListener('click', e => { if (e.target === fileModalOverlay) hideFileModal(); });
        confirmYesBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(true); hideConfirmModal(); }); confirmNoBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(false); hideConfirmModal(); });
        infoOkBtn.addEventListener('click', hideInfoModal); infoModalOverlay.addEventListener('click', e => { if (e.target === infoModalOverlay) hideInfoModal(); });
        closeViewerBtn.addEventListener('click', hideViewer); viewerModalOverlay.addEventListener('click', e => { if (e.target === viewerModalOverlay) hideViewer(); });
        
        // (修改) 锁死汉堡菜单: 如果处于选择模式，阻止打开侧边栏
        hamburgerMenu.addEventListener('click', () => { 
            if (isSelectionMode) return; 
            sidebar.classList.add('open'); 
            sidebarOverlay.classList.add('visible'); 
        }); 
        
        sidebarOverlay.addEventListener('click', () => { sidebar.classList.remove('open'); sidebarOverlay.classList.remove('visible'); }); const closeSidebar = () => { sidebar.classList.remove('open'); sidebarOverlay.classList.remove('visible'); };
        
        // --- 添加文案按钮逻辑：自动填充分组 ---
        addNoteBtn.addEventListener('click', () => {
            showNoteModal('add');
            // 如果当前不在"全部"、"文案"或"文件"这些特殊视图下，则预填分组
            const specialGroups = ['all', 'notes_only', 'files_only'];
            if (currentFilterGroup && !specialGroups.includes(currentFilterGroup)) {
                noteGroupInput.value = currentFilterGroup;
            }
        });

        groupList.addEventListener('click', (e) => { const li = e.target.closest('li'); if (li && li.dataset.group) { currentFilterGroup = li.dataset.group; refreshUI(); closeSidebar(); } });

        const renderKeywords = () => { searchWrapper.querySelectorAll('.keyword-tag').forEach(tag => tag.remove()); searchKeywords.forEach(keyword => { const tag = document.createElement('span'); tag.className = 'keyword-tag'; tag.innerHTML = `<span>${escapeHTML(keyword)}</span><button class="remove-tag" data-keyword="${escapeHTML(keyword)}" title="移除">&times;</button>`; searchWrapper.insertBefore(tag, searchInput); }); renderItems(); };
        searchInput.addEventListener('input', () => { const value = searchInput.value; if (value.endsWith(' ') && value.trim() !== '') { const keyword = value.slice(0, -1).trim(); if (keyword && !searchKeywords.includes(keyword)) searchKeywords.push(keyword); searchInput.value = ''; renderKeywords(); } renderItems(); });
        searchInput.addEventListener('keydown', (e) => { if (e.key === 'Backspace' && searchInput.value === '' && searchKeywords.length > 0) { const last = searchKeywords.pop(); searchInput.value = last + ' '; renderKeywords(); renderItems(); } });
        searchWrapper.addEventListener('click', (e) => { if (e.target.classList.contains('remove-tag')) { searchKeywords = searchKeywords.filter(k => k !== e.target.dataset.keyword); renderKeywords(); } else if (e.target === searchWrapper || e.target.classList.contains('keyword-tag')) { searchInput.focus(); } });

        let copyTimeout; const copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(() => { clearTimeout(copyTimeout); copyFeedback.classList.add('show'); copyTimeout = setTimeout(() => copyFeedback.classList.remove('show'), 1500); }).catch(() => showInfoModal('复制失败！')); };
        let draggedItem = null;
        groupList.addEventListener('dragstart', (e) => { if (e.target.classList.contains('draggable')) { draggedItem = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); } });
        groupList.addEventListener('dragover', (e) => { e.preventDefault(); const afterElement = [...groupList.querySelectorAll('.draggable:not(.dragging)')].reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = e.clientY - box.top - box.height / 2; return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest; }, { offset: Number.NEGATIVE_INFINITY }).element; if (afterElement == null) groupList.appendChild(document.querySelector('.dragging')); else groupList.insertBefore(document.querySelector('.dragging'), afterElement); });
        groupList.addEventListener('dragend', () => { if(draggedItem) draggedItem.classList.remove('dragging'); const newOrder = [...groupList.querySelectorAll('.draggable')].map(li => li.dataset.group); groupOrder = newOrder; saveGroupOrder(); });

        const setupGroupInput = (input, dropdown, toggle) => {
            const render = () => { const f = input.value.toLowerCase(); const g = getAllGroups().filter(grp => grp.toLowerCase().includes(f)); dropdown.innerHTML = ''; if (g.length > 0) { [...new Set(g)].forEach(grp => { const i = document.createElement('div'); i.className = 'dropdown-item'; i.textContent = grp; i.addEventListener('mousedown', () => { input.value = grp; dropdown.classList.remove('visible'); }); dropdown.appendChild(i); }); dropdown.classList.add('visible'); } else { dropdown.classList.remove('visible'); } };
            toggle.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.contains('visible') ? dropdown.classList.remove('visible') : render(); });
            input.addEventListener('focus', render); input.addEventListener('input', render);
            document.addEventListener('click', (e) => { if (!input.parentElement.contains(e.target)) dropdown.classList.remove('visible'); });
        };
        setupGroupInput(noteGroupInput, noteGroupDropdown, noteForm.querySelector('.group-dropdown-toggle'));
        setupGroupInput(fileGroupInput, fileGroupDropdown, fileForm.querySelector('.group-dropdown-toggle'));

        // --- 13. 分享与多选功能 ---

        // 13.1 创建“分享”按钮并添加到侧边栏
        const shareBtn = document.createElement('button');
        shareBtn.textContent = '分享';
        shareBtn.id = 'share-btn';
        if (sidebarActions) {
            sidebarActions.insertBefore(shareBtn, sidebarActions.firstChild); // 放在第一个
        }
        
        // 13.2 创建底部操作栏
        const selectionBar = document.createElement('div');
        selectionBar.id = 'selection-bar';
        selectionBar.innerHTML = `
            <div class="selection-info">已选: <span id="sel-count">0</span></div>
            <div class="selection-actions">
                <button id="sel-all-btn">全选</button>
                <button id="sel-inv-btn">反选</button>
                <button id="sel-cancel-btn">取消</button>
                <button id="sel-export-btn">导出TXT</button>
            </div>
        `;
        document.body.appendChild(selectionBar);
        
        const selCountSpan = document.getElementById('sel-count');
        
        // 13.3 功能逻辑
        const updateSelectionCount = () => {
            const count = itemsContainer.querySelectorAll('.note-card.selected').length;
            selCountSpan.textContent = count;
        };

        const enterSelectionMode = () => {
            isSelectionMode = true;
            document.body.classList.add('selection-mode');
            selectionBar.classList.add('visible');
            closeSidebar(); // 关闭侧边栏
            
            // 清空之前的选择
            itemsContainer.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            updateSelectionCount();
            
            // (修改) 不再弹窗提示
        };

        const exitSelectionMode = () => {
            isSelectionMode = false;
            document.body.classList.remove('selection-mode');
            selectionBar.classList.remove('visible');
            itemsContainer.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
        };

        shareBtn.addEventListener('click', enterSelectionMode);

        document.getElementById('sel-cancel-btn').addEventListener('click', exitSelectionMode);

        // (修改) 全选/取消全选 智能切换
        document.getElementById('sel-all-btn').addEventListener('click', () => {
            const allNotes = itemsContainer.querySelectorAll('.note-card');
            const allSelected = itemsContainer.querySelectorAll('.note-card.selected');
            
            if (allNotes.length > 0 && allNotes.length === allSelected.length) {
                // 如果已经全部选中，则取消全选
                allNotes.forEach(el => el.classList.remove('selected'));
            } else {
                // 否则，全选
                allNotes.forEach(el => el.classList.add('selected'));
            }
            updateSelectionCount();
        });

        document.getElementById('sel-inv-btn').addEventListener('click', () => {
            itemsContainer.querySelectorAll('.note-card').forEach(el => el.classList.toggle('selected'));
            updateSelectionCount();
        });

        document.getElementById('sel-export-btn').addEventListener('click', () => {
            const selectedEls = itemsContainer.querySelectorAll('.note-card.selected'); // 仅导本文案
            const count = selectedEls.length;
            if (count === 0) {
                showInfoModal('请至少选择一条文案！<br><small>暂不支持导出文件</small>');
                return;
            }

            // 收集内容
            const contents = [];
            selectedEls.forEach(el => {
                const id = parseInt(el.dataset.id);
                const note = notes.find(n => n.id === id);
                if (note) contents.push(note.content);
            });

            // 生成TXT
            const textContent = contents.join('\n\n'); // 用空行隔开
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // 文件名处理：如果有分组名则用分组名，否则用日期
            let filename = '文案分享';
            if (currentFilterGroup && !['all', 'notes_only', 'files_only'].includes(currentFilterGroup)) {
                filename = currentFilterGroup;
            } else {
                const d = new Date();
                filename += `_${d.getMonth()+1}-${d.getDate()}`;
            }
            
            a.download = `${filename}.txt`;
            a.href = url;
            a.click();
            URL.revokeObjectURL(url);
            
            exitSelectionMode();
            showInfoModal(`成功导出 ${count} 条文案！`);
        });

        // --- 12. 启动与迁移 ---
        loadTheme();
        await initDB();
        
        const oldNotes = JSON.parse(localStorage.getItem('notes-app-data'));
        if (oldNotes && Array.isArray(oldNotes) && oldNotes.length > 0) {
            console.log('检测到旧缓存数据，正在迁移到数据库...');
            for (const n of oldNotes) {
                const noteObj = { ...n, type: 'note' };
                delete noteObj.id;
                await dbActions.add(noteObj);
            }
            localStorage.removeItem('notes-app-data'); 
        }

        groupOrder = JSON.parse(localStorage.getItem('group-order-data')) || [];
        searchFilterGroups = JSON.parse(localStorage.getItem('search-filter-groups')) || [];
        updateSearchFilterBtnState();
        await refreshUI();
    });
</script>

</body>
</html>
